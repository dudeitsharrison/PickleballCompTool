<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2034792889395341"
    crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Pickle Pairs | Doing Doubles Right</title>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Pickle Pairs - The Pickleball Matchmaker | Doing Doubles Right">
    <meta property="og:description" content="Pairing picklers for unique matches every round. 🥒">
    <meta property="og:image" content="smallicon.png">
    <meta property="og:url" content="">
    <meta property="og:type" content="website">
    
    <!-- AdSense Verification - Replace content with your actual AdSense publisher ID when provided -->
    <meta name="google-adsense-account" content="ca-pub-2034792889395341">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* Scroll locking styles */
        html.no-scroll,
        body.no-scroll {
            overflow: hidden !important;
        }
        
        .intro-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.98);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.7s ease-out;
            overflow: hidden;
        }
        
        /* Remove the body.intro-active class as it's no longer needed */
        
        /* Logo Flip Animation Styles */
        .logo-flip-container {
            perspective: 1000px;
            width: 200px;
            height: 200px;
            margin: 0 auto;
            cursor: pointer;
        }
        
        .logo-flipper {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        
        .logo-flip-container:hover .logo-flipper {
            transform: rotateY(180deg);
        }
        
        .logo-front, .logo-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-back {
            transform: rotateY(180deg);
        }
        
        .back-logo {
            transform: scale(1.2); /* Zoomed in slightly */
        }
        
        /* Header logo specific styles */
        .header-logo-flip {
            width: 100px;
            height: 100px;
        }
        
        .header-logo-flip .logo-flipper {
            transition: transform 0.6s; /* Slightly faster in header */
        }
        
        #header-logo, #header-logo-back {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
        
        /* Mobile specific styles */
        @media (max-width: 768px) {
            .logo-flip-container:active .logo-flipper {
                transform: rotateY(180deg);
            }
        }
        
        /* Intro info styles */
        .intro-info-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            max-width: 80%;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .intro-content.animate-in .intro-info-container {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.6s; /* Appear after slogan */
        }
        
        .intro-info-logo {
            height: 40px;
            width: auto;
            margin-right: 15px;
        }
        
        .intro-info-text {
            font-size: 16px;
            color: #555;
            text-align: left;
            line-height: 1.4;
        }
        
        /* Mobile adjustments for info text */
        @media (max-width: 768px) {
            .intro-info-container {
                flex-direction: column;
                text-align: center;
            }
            
            .intro-info-logo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .intro-info-text {
                text-align: center;
            }
        }
        

        
        .toggle-debug-btn:hover {
            background-color: var(--neutral-light); /* Lighter gray on hover */
            color: var(--primary-dark);
        }
        
        
        .toggle-info-btn:hover {
            background-color: #7ec5ff;
        }
        
        /* Settings Panel Styles */
        .settings-panel {
            position: fixed;
            bottom: 50px;
            left: 10px;
            width: 300px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 15px;
            z-index: 2200; /* Same as the settings button */
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Help Panel Styles */
        .help-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 450px; /* Wider by default */
            height: 100vh;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        /* For wider screens, make the help panel wider */
        @media (min-width: 1200px) {
            .help-panel {
                width: 520px; /* Wider panel for larger screens */
            }
        }
        
        /* For ultra-wide screens, increase panel width further */
        @media (min-width: 1800px) {
            .help-panel {
                width: 600px; /* Even wider for ultra-wide screens */
            }
        }
        
        .help-panel.active {
            transform: translateX(0);
        }
        
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .help-header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .help-header-title h2 {
            margin: 0;
            color: #333;
        }
        
        .help-logo {
            width: 40px;
            height: 40px;
        }
        
        .help-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .help-section h3 {
            color: #4CAF50;
            margin-top: 0;
            font-size: 18px;
        }
        
        .help-section p {
            color: #555;
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .help-feature {
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 3px solid #4CAF50;
        }
        
        .help-feature h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .help-feature p {
            margin: 0;
            font-size: 14px;
        }
        
        .pickle-highlight {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .help-close-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 24px;
        }
        
        .help-close-btn:hover {
            color: #333;
        }
        
        .leaderboard-explanation {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .leaderboard-explanation h4 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .metric-description {
            display: flex;
            margin-bottom: 8px;
        }
        
        .metric-name {
            font-weight: bold;
            min-width: 130px;
        }
        
        .help-footer {
            text-align: center;
            margin-top: 30px;
            color: #999;
            font-size: 12px;
        }
        
        /* Mobile adjustments for help panel */
        @media (max-width: 768px) {
            .help-panel {
                width: 85vw;
            }
        }
        
        .settings-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        
        .settings-toggles {
            margin-bottom: 20px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        /* Setting label font color update */
        .setting-label {
            font-size: 14px;
            color: white;
        }
        
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Debug Section Styles */
        .debug-section {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .debug-header h4 {
            margin: 0;
            color: #555;
            font-size: 14px;
        }
        
        #debugArea {
            width: 100%;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        
      
        
        [data-tooltip]:hover:after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* Ranking modes carousel styles */
        .ranking-carousel {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .ranking-slide {
            display: none;
            animation: fadeEffect 0.5s;
        }
        
        .ranking-slide.active {
            display: block;
        }
        
        @keyframes fadeEffect {
            from {opacity: 0.7;}
            to {opacity: 1;}
        }
        
        .ranking-title {
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ranking-description {
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .ranking-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .ranking-dots {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .ranking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ccc;
            cursor: pointer;
        }
        
        .ranking-dot.active {
            background-color: #4CAF50;
        }
        
        .ranking-btn {
            background: none;
            border: none;
            color: #4CAF50;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ranking-btn:hover {
            color: #45a049;
        }
        
        .ranking-btn:disabled {
            color: #ccc;
            cursor: default;
        }
        
        .ranking-slide ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        
        .ranking-slide li {
            margin-bottom: 5px;
        }
        
        /* Feature visual example styles */
        .feature-visual {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Dancing pickle guide styles */
        .dancing-pickle-guide {
            position: fixed;
            top: 80px;
            right: 40px;
            z-index: 1005;
            animation: bounceAndSpin 2.5s infinite;
            cursor: pointer;
            width:50px;
            height: 50px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 20px;
        }
        
        @keyframes bounceAndSpin {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            25% {
                transform: translateY(-10px) rotate(20deg);
            }
            50% {
                transform: translateY(0) rotate(0deg);
            }
            75% {
                transform: translateY(-5px) rotate(-20deg);
            }
        }
        
        .status-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            width: 60px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .toggle-active {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }
        
        .toggle-inactive {
            background-color: rgba(255, 152, 0, 0.2);
            border: 1px solid #FF9800;
            color: #FF9800;
        }
        
        .toggle-now-label {
            position: absolute;
            top: -7px;
            right: -7px;
            background-color: #F44336;
            color: white;
            border-radius: 3px;
            padding: 1px 3px;
            font-size: 8px;
            font-weight: bold;
            transform: rotate(20deg);
        }
        
        .feature-visual img {
            max-width: 100%;
            border-radius: 4px;
        }
        
        .button-example {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .button-example.primary {
            background-color: #2196F3;
        }
        
        .button-example.success {
            background-color: #4CAF50;
        }
        
        .button-example.danger {
            background-color: #F44336;
        }
        
        .button-example.info {
            background-color: rgb(68, 155, 255);
        }
        
        .ui-example {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .ui-example .material-symbols-rounded {
            margin-right: 8px;
        }
        
        .feature-section-icon {
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        /* Photo capture mode adjustments */
        .photo-capture-mode {
            position: relative;
            transform: none;
            height: auto;
            max-height: none; /* Fixed: 'auto' to 'none' */
            overflow: visible;
            z-index: 10001; /* Higher than settings */
        }
        
        /* Hide settings during photo capture */
        .photo-capture-mode ~ .toggle-debug-btn,
        .photo-capture-mode ~ .settings-panel,
        .photo-capture-mode .toggle-debug-btn,
        .photo-capture-mode .settings-panel {
            display: none !important;
        }
        
        /* Keep the floating capture button visible during photo capture */
        .photo-capture-mode ~ .toggle-capture-btn,
        .photo-capture-mode .toggle-capture-btn {
            display: flex !important;
            z-index: 10002 !important; /* Higher than photo-capture-mode */
        }
        
    </style>
    <script>
        // Ensure page starts at the top and lock scrolling
        window.onbeforeunload = function() {
            window.scrollTo(0, 0);
        };
        
        // Function to toggle scroll locking
        function toggleScrollLock(lock) {
            if (lock) {
                // Store current scroll position
                window.scrollLockPosition = window.scrollY || document.documentElement.scrollTop;
                
                // Apply scroll lock
                document.documentElement.classList.add('no-scroll');
                document.body.classList.add('no-scroll');
                
                // Store original styles
                document.body.dataset.originalPosition = document.body.style.position;
                document.body.dataset.originalTop = document.body.style.top;
                document.body.dataset.originalLeft = document.body.style.left;
                document.body.dataset.originalWidth = document.body.style.width;
                document.body.dataset.originalHeight = document.body.style.height;
                
                // Set fixed position with current scroll
                document.body.style.position = 'fixed';
                document.body.style.top = `-${window.scrollLockPosition}px`;
                document.body.style.left = '0';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
            } else {
                // Remove scroll lock classes
                document.documentElement.classList.remove('no-scroll');
                document.body.classList.remove('no-scroll');
                
                // Restore original styles
                document.body.style.position = document.body.dataset.originalPosition || '';
                document.body.style.top = document.body.dataset.originalTop || '';
                document.body.style.left = document.body.dataset.originalLeft || '';
                document.body.style.width = document.body.dataset.originalWidth || '';
                document.body.style.height = document.body.dataset.originalHeight || '';
                
                // Clean up dataset
                delete document.body.dataset.originalPosition;
                delete document.body.dataset.originalTop;
                delete document.body.dataset.originalLeft;
                delete document.body.dataset.originalWidth;
                delete document.body.dataset.originalHeight;
                
                // Restore scroll position
                if (window.scrollLockPosition !== undefined) {
                    window.scrollTo(0, window.scrollLockPosition);
                    delete window.scrollLockPosition;
                }
            }
        }
        
        // Lock scrolling when page loads only if intro container will be shown
        document.addEventListener('DOMContentLoaded', function() {
            // Only lock scrolling if skip intro is not enabled
            const skipIntro = localStorage.getItem('skipIntro') === 'true';
            if (!skipIntro) {
                toggleScrollLock(true);
            }
        });
        
        // Remove the body class addition since we're using the intro container's fixed positioning
    </script>
</head>
<body>
    <!-- Add audio elements -->
    <audio id="introAudio" preload="auto">
        <source src="picklepairsMain.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <audio id="leaderboardAudio" preload="auto">
        <source src="picklepairsLeaderBoard.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="intro-animation" class="intro-container">
        <div class="intro-content">
            <div class="logo-flip-container">
                <div class="logo-flipper">
                    <div class="logo-front">
                        <img src="Picklepairs.png" alt="Pickle Pairs Logo" class="intro-logo">
                    </div>
                    <div class="logo-back">
                        <img src="simplelogot.png" alt="Simple Logo" class="intro-logo back-logo">
                    </div>
                </div>
            </div>
            <h1>Pickle Pairs</h1>
            <p class="slogan">Doing Doubles Right</p>
            
            <!-- Info text container -->
            <div class="intro-info-container">
                <img src="simplelogot.png" alt="Pickle Pairs Logo" class="intro-info-logo">
                <p class="intro-info-text">Pickle Pairs is a Pickleball matchmaking app providing unique pairings every round.</p>
            </div>
            
            <div id="startButton" class="start-button">
                <span class="pickle-icon">🥒</span>
                <span>Let's Pickle!</span>
            </div>
            <div class="intro-copyright">
            &copy; 2025 PicklePairs | All code and intellectual property © PicklePairs. No reproduction or derivative use permitted.
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-logo">
            <div class="logo-flip-container header-logo-flip">
                <div class="logo-flipper">
                    <div class="logo-front">
                        <img src="Picklepairs.png" alt="Pickle Pairs Logo" id="header-logo">
                    </div>
                    <div class="logo-back">
                        <img src="simplelogot.png" alt="Simple Logo" id="header-logo-back" class="back-logo">
                    </div>
                </div>
            </div>
            <h1 id="title">Pickle Pairs</h1>
            <p class="subtitle">Doing Doubles Right</p>
        </div>

        <!-- Player Input Section -->
        <section class="navigation">
            <textarea id="playerInput" placeholder="Enter player names separated by commas or line breaks..."></textarea>
            <div id="playerCount">Player Count: 0</div>
            <div class="navigation-controls">
                <!-- First row - Most important buttons first -->
                <button id="startTournament" class="btn-success">
                    <span class="material-symbols-rounded">sports_tennis</span>
                    START TOURNAMENT
                </button>
                <button id="showPodiumBtn" class="btn-primary">
                    <span class="material-symbols-rounded">emoji_events</span>
                    LEADERBOARD
                </button>
                <button id="addPlayersBtn">
                    <span class="material-symbols-rounded">group_add</span>
                    ADD PLAYERS
                </button>
                <div class="court-select-container">
                    <label for="courtSelect">Courts:</label>
                    <select id="courtSelect">
                        <option value="1">1 Court</option>
                        <option value="2">2 Courts</option>
                        <option value="3">3 Courts</option>
                        <option value="4">4 Courts</option>
                        <option value="5">5 Courts</option>
                        <option value="6">6 Courts</option>
                    </select>
                </div>
                <!-- Second row - Secondary actions -->
                <button id="matchesPlayed">
                    <span class="material-symbols-rounded">history</span>
                    MATCH HISTORY
                </button>
            </div>
            
            <!-- Guide Arrow -->
            <div id="guideArrow" class="guide-arrow">
                <div class="guide-arrow-content">
                    <span class="guide-pickle">🥒</span>
                    <span class="guide-arrow-point material-symbols-rounded">arrow_downward</span>
                </div>
                <p class="guide-text">Start here!</p>
            </div>
            
            <!-- Import/Export Controls, separated from main navigation -->
            <div class="import-export-controls">
                <button id="exportBtn">
                    <span class="material-symbols-rounded">download</span>
                    EXPORT DATA
                </button>
                <label for="importFile" class="file-input-label">
                    <span class="material-symbols-rounded">upload</span>
                    IMPORT DATA
                    <input type="file" id="importFile" class="hidden" accept=".json">
                </label>
                <button id="clearBtn" class="btn-danger">
                    <span class="material-symbols-rounded">delete</span>
                    CLEAR DATA
                </button>
            </div>
        </section>

        <!-- Round Setup Section -->
        <div class="round-setup">
            <!-- Dynamically populated by JS -->
        </div>

        <!-- Floating Player List Panel -->
        <div id="playerListContainer" class="floating-panel">
            <h2>Players</h2>
            <div id="playerListContainerTable">
                <table id="playerTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="playerList"></tbody>
                </table>
            </div>
        </div>
        <button id="togglePlayerList" class="playerlist-toggle-btn" aria-label="Toggle player list">
            <span class="material-symbols-rounded">people</span>
        </button>

        <!-- Floating Buttons Container -->
        <div class="floating-buttons-container-left">
            <!-- Toggle tab for left container -->
            <div class="floating-toggle-tab">
                <span class="material-symbols-rounded chevron-icon">chevron_right</span>
            </div>
            <!-- Floating capture all button -->
            <button id="saveAsPictureBtn" class="floating-button toggle-capture-btn dual-camera-mode">
                <div class="photo-icon-container">
                    <span class="material-symbols-rounded">photo_library</span>
                    <span class="material-symbols-rounded camera-icon">photo_camera</span>
                </div>
            </button>
            <button id="toggleInfoBtn" class="floating-button toggle-info-btn">
                <span class="material-symbols-rounded">info</span>
            </button>
           
            <button id="toggleMainAudioBtn" class="floating-button toggle-mute-btn fixed-position">
                <span class="material-symbols-rounded">volume_up</span>
            </button>
            <!-- Info button for help panel -->
            <!-- Debug toggle button - rename to settings -->
            <button id="toggleDebugBtn" class="floating-button toggle-debug-btn">
                <span class="material-symbols-rounded">settings</span>
            </button>
        </div>

        <div class="floating-buttons-container">
            <!-- Toggle tab for right container -->
            <div class="floating-toggle-tab">
                <span class="material-symbols-rounded chevron-icon">chevron_left</span>
            </div>
            <!-- Leaderboard Button -->
            <button id="floatingLeaderboardBtn" class="floating-button leaderboard-btn" aria-label="Show leaderboard">
                <span class="material-symbols-rounded">emoji_events</span>
            </button>

            <!-- Match History Button -->
            <button id="floatingMatchHistoryBtn" class="floating-button floating-history-btn" title="Match History">
                <span class="material-symbols-rounded">history</span>
            </button>

            <!-- Back to Top Button -->
            <button id="backToTopBtn" class="floating-button back-to-top-btn" aria-label="Back to top">
                <span class="material-symbols-rounded">arrow_upward</span>
            </button>
            
            <!-- Current Round Button -->
            <button id="scrollToCurrentRound" class="floating-button round-nav-btn" aria-label="Scroll to current round">
                <span class="material-symbols-rounded">arrow_downward</span>
                <span class="btn-text">Current Round</span>
            </button>
        </div>

        <!-- Match Display Section -->
        <div id="matchDisplay" class="match-display"></div>
        
        <!-- Bottom Continue Playing Button - Only shows when data is loaded -->
        <div id="bottomContinueContainer" style="display: none; margin: 20px 0; text-align: center;">
            <button id="bottomContinueBtn" class="btn-success">
                <span class="material-symbols-rounded">sports_tennis</span>
                CONTINUE PLAYING
            </button>
        </div>

        <!-- Footer with extra space for proper scrolling -->
        <footer class="site-footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>About Pickle Pairs</h3>
                    <p>Pickle Pairs is designed to help organize and track pickleball matches dynamically, avoiding repeat pairs and unique matches until all matches are exhausted. It also keeps track of player stats, has match history, a leaderboard, and ensures fair play.</p>
                
                </div>
                <div class="footer-section">
                    <h3>Coming Soon</h3>
                    <ul>
                        <li>Bug Reports</li>
                        <li>Feature Requests</li>
                        <li>Contact / Support</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact & Support</h3>
                    
    <iframe
    id="JotFormIFrame-250965783330462"
    title="Pickle Pairs - Bug Tracker and Recommendations"
    onload="window.parent.scrollTo(0,0)"
    allowtransparency="true"
    allow="geolocation; microphone; camera; fullscreen"
    src="https://form.jotform.com/250965783330462"
    frameborder="0"
    style="min-width:100%;max-width:100%;height:539px;border:none;"
    scrolling="no"
  >
  </iframe>
  <script src='https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js'></script>
  <script>window.jotformEmbedHandler("iframe[id='JotFormIFrame-250965783330462']", "https://form.jotform.com/")</script>
  
                    <p>For bugs, check the Debug Log (Gear icon) and copy it to your clipboard using the copy button, and paste it in the debug log section on the Bug Tracker Form.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Pickle Pairs - Harrison Engle - All rights reserved.</p>
                <p class="license-notice">All code and intellectual property © PicklePairs. No reproduction or derivative use permitted.</p>
                <p class="license-notice">All rights reserved. Protected under international copyright and intellectual property law.</p>
            </div>
        </footer>

        <!-- Podium Display Section -->
        <div id="podiumDisplay" class="podium-container">
            <img src="simplelogotbase64renamed.png" alt="Pickle Pairs Logo" style="display: block; margin: 0 auto; max-width: 150px;" crossorigin="anonymous">
            <h2 style="text-align: center;">Top Picklers</h2>
            <div id="dateDisplay"></div>
            <button id="closePodiumBtn">
                <span class="material-symbols-rounded">close</span>
            </button>

            <!-- Sorting Buttons -->
            <div class="sorting-buttons">
                <button id="sortVictoryPoints">Victory Points</button>
                <button id="sortPicklePoints">Pickle Points</button>
                <button id="sortWinPercentage">Win %</button>
                <button id="sortPicklePointAvg">Pickle Points Avg</button>
                <button id="sortPickleDifferential">Pickle Differential</button>
            </div>

            <!-- Podium Standings -->
            <div class="podium">
                <div class="podium-place silver">
                    <div class="placementtitle">🥈</div>
                    <div class="player-name" id="silver"></div>
                </div>
                <div class="podium-place gold">
                    <div class="confetti-container">
                        <div class="confetti"></div>
                        <div class="confetti"></div>
                        <div class="confetti"></div>
                        <div class="confetti"></div>
                        <div class="confetti"></div>
                    </div>
                    <div class="placementtitle">🥇</div>
                    <div class="player-name" id="gold"></div>
                </div>
                <div class="podium-place bronze">
                    <div class="placementtitle">🥉</div>
                    <div class="player-name" id="bronze"></div>
                </div>
            </div>

            <!-- Player Stats Table -->
            <div class="table-wrapper">
                <table id="playerStatsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Games</th>
                            <th>Victory Pts</th>
                            <th>Win %</th>
                            <th>Pickle Pts</th>
                            <th>Differential</th>
                            <th>Pt Avg</th>
                            <th>Teammates</th>
                            <th>Versus</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamically filled by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Match History Modal -->
        <div id="matchHistoryDisplay">
            <img src="simplelogotbase64renamed.png" alt="Pickle Pairs Logo" style="display: block; margin: 0 auto; max-width: 150px;" crossorigin="anonymous">
            <h2 style="text-align: center;">Match History</h2>
            <div id="matchHistoryContent"></div>
            <button id="closeMatchHistoryBtn">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        
        <!-- Support Panel -->
        <div id="support-panel" class="support-panel">
            <div class="support-panel-header">
                <h2>Support This Project</h2>
                <button class="close-support-btn" onclick="toggleSupportPanel()">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="support-panel-content">
                <div class="support-section">
                    <h3>Buy Me a Coffee</h3>
                    <p>If you find this tool helpful in your pickleball events, please consider supporting its continued development.</p>
                    <div class="bmc-container">
                        <a href="https://buymeacoffee.com/L5ff3Ti0zc" target="_blank" class="bmc-link">
                            <img src="bmc_qr.png" alt="Buy Me A Coffee QR Code" class="bmc-qr">
                        </a>
                        <p class="bmc-text">Scan the QR code or visit:</p>
                        <a href="https://buymeacoffee.com/L5ff3Ti0zc" target="_blank" class="bmc-button">
                            buymeacoffee.com/L5ff3Ti0zc
                        </a>
                    </div>
                    <p class="support-thanks">Thank you for your support!</p>
                </div>
            </div>
        </div>

        <!-- Support Button (Buy Me a Coffee) -->
        <button id="supportButton" class="support-btn" onclick="toggleSupportPanel()" aria-label="Support this project">
            <svg width="24" height="24" viewBox="0 0 884 1279" fill="none" xmlns="http://www.w3.org/2000/svg" class="support-icon">
                <path d="M472.623 590.836C426.682 610.503 374.546 632.802 306.976 632.802C278.71 632.746 250.58 628.868 223.353 621.274L270.086 1101.08C271.74 1121.13 280.876 1139.83 295.679 1153.46C310.482 1167.09 329.87 1174.65 349.992 1174.65C349.992 1174.65 416.254 1178.09 438.365 1178.09C462.161 1178.09 533.516 1174.65 533.516 1174.65C553.636 1174.65 573.019 1167.08 587.819 1153.45C602.619 1139.82 611.752 1121.13 613.406 1101.08L663.459 570.876C641.091 563.237 618.516 558.161 593.068 558.161C549.054 558.144 513.591 573.303 472.623 590.836Z" fill="#FFDD00"></path>
                <path d="M879.567 341.849L872.53 306.352C866.215 274.503 851.882 244.409 819.19 232.898C808.711 229.215 796.821 227.633 788.786 220.01C780.751 212.388 778.376 200.55 776.518 189.572C773.076 169.423 769.842 149.257 766.314 129.143C763.269 111.85 760.86 92.4243 752.928 76.56C742.604 55.2584 721.182 42.8009 699.88 34.559C688.965 30.4844 677.826 27.0375 666.517 24.2352C613.297 10.1947 557.342 5.03277 502.591 2.09047C436.875 -1.53577 370.983 -0.443234 305.422 5.35968C256.625 9.79894 205.229 15.1674 158.858 32.0469C141.91 38.224 124.445 45.6399 111.558 58.7341C95.7448 74.8221 90.5829 99.7026 102.128 119.765C110.336 134.012 124.239 144.078 138.985 150.737C158.192 159.317 178.251 165.846 198.829 170.215C256.126 182.879 315.471 187.851 374.007 189.968C438.887 192.586 503.87 190.464 568.44 183.618C584.408 181.863 600.347 179.758 616.257 177.304C634.995 174.43 647.022 149.928 641.499 132.859C634.891 112.453 617.134 104.538 597.055 107.618C594.095 108.082 591.153 108.512 588.193 108.942L586.06 109.252C579.257 110.113 572.455 110.915 565.653 111.661C551.601 113.175 537.515 114.414 523.394 115.378C491.768 117.58 460.057 118.595 428.363 118.647C397.219 118.647 366.058 117.769 334.983 115.722C320.805 114.793 306.661 113.611 292.552 112.177C286.134 111.506 279.733 110.801 273.333 110.009L267.241 109.235L265.917 109.046L259.602 108.134C246.697 106.189 233.792 103.953 221.025 101.251C219.737 100.965 218.584 100.249 217.758 99.2193C216.932 98.1901 216.482 96.9099 216.482 95.5903C216.482 94.2706 216.932 92.9904 217.758 91.9612C218.584 90.9319 219.737 90.2152 221.025 89.9293H221.266C232.33 87.5721 243.479 85.5589 254.663 83.8038C258.392 83.2188 262.131 82.6453 265.882 82.0832H265.985C272.988 81.6186 280.026 80.3625 286.994 79.5366C347.624 73.2301 408.614 71.0801 469.538 73.1014C499.115 73.9618 528.676 75.6996 558.116 78.6935C564.448 79.3474 570.746 80.0357 577.043 80.8099C579.452 81.1025 581.878 81.4465 584.305 81.7391L589.191 82.4445C603.438 84.5667 617.61 87.1419 631.708 90.1703C652.597 94.7128 679.422 96.1925 688.713 119.077C691.673 126.338 693.015 134.408 694.649 142.03L696.732 151.752C696.786 151.926 696.826 152.105 696.852 152.285C701.773 175.227 706.7 198.169 711.632 221.111C711.994 222.806 712.002 224.557 711.657 226.255C711.312 227.954 710.621 229.562 709.626 230.982C708.632 232.401 707.355 233.6 705.877 234.504C704.398 235.408 702.75 235.997 701.033 236.236H700.895L697.884 236.649L694.908 237.044C685.478 238.272 676.038 239.419 666.586 240.486C647.968 242.608 629.322 244.443 610.648 245.992C573.539 249.077 536.356 251.102 499.098 252.066C480.114 252.57 461.135 252.806 442.162 252.771C366.643 252.712 291.189 248.322 216.173 239.625C208.051 238.662 199.93 237.629 191.808 236.58C198.106 237.389 187.231 235.96 185.029 235.651C179.867 234.928 174.705 234.177 169.543 233.397C152.216 230.798 134.993 227.598 117.7 224.793C96.7944 221.352 76.8005 223.073 57.8906 233.397C42.3685 241.891 29.8055 254.916 21.8776 270.735C13.7217 287.597 11.2956 305.956 7.64786 324.075C4.00009 342.193 -1.67805 361.688 0.472751 380.288C5.10128 420.431 33.165 453.054 73.5313 460.35C111.506 467.232 149.687 472.807 187.971 477.556C338.361 495.975 490.294 498.178 641.155 484.129C653.44 482.982 665.708 481.732 677.959 480.378C681.786 479.958 685.658 480.398 689.292 481.668C692.926 482.938 696.23 485.005 698.962 487.717C701.694 490.429 703.784 493.718 705.08 497.342C706.377 500.967 706.846 504.836 706.453 508.665L702.633 545.797C694.936 620.828 687.239 695.854 679.542 770.874C671.513 849.657 663.431 928.434 655.298 1007.2C653.004 1029.39 650.71 1051.57 648.416 1073.74C646.213 1095.58 645.904 1118.1 641.757 1139.68C635.218 1173.61 612.248 1194.45 578.73 1202.07C548.022 1209.06 516.652 1212.73 485.161 1213.01C450.249 1213.2 415.355 1211.65 380.443 1211.84C343.173 1212.05 297.525 1208.61 268.756 1180.87C243.479 1156.51 239.986 1118.36 236.545 1085.37C231.957 1041.7 227.409 998.039 222.9 954.381L197.607 711.615L181.244 554.538C180.968 551.94 180.693 549.376 180.435 546.76C178.473 528.023 165.207 509.681 144.301 510.627C126.407 511.418 106.069 526.629 108.168 546.76L120.298 663.214L145.385 904.104C152.532 972.528 159.661 1040.96 166.773 1109.41C168.15 1122.52 169.44 1135.67 170.885 1148.78C178.749 1220.43 233.465 1259.04 301.224 1269.91C340.799 1276.28 381.337 1277.59 421.497 1278.24C472.979 1279.07 524.977 1281.05 575.615 1271.72C650.653 1257.95 706.952 1207.85 714.987 1130.13C717.282 1107.69 719.576 1085.25 721.87 1062.8C729.498 988.559 737.115 914.313 744.72 840.061L769.601 597.451L781.009 486.263C781.577 480.749 783.905 475.565 787.649 471.478C791.392 467.391 796.352 464.617 801.794 463.567C823.25 459.386 843.761 452.245 859.023 435.916C883.318 409.918 888.153 376.021 879.567 341.849Z" fill="#0D0C22"></path>
            </svg>
        </button>

     
        <!-- Settings container (formerly debug area) -->
        <div id="debugAreaContainer" style="display: none;" class="settings-panel">
            <div class="settings-header">
                <h3>Settings</h3>
            </div>
            
            <div class="settings-toggles">
                <!-- Skip Intro Toggle -->
                <div class="setting-item">
                    <label for="skipIntroToggle" class="setting-label">Skip Intro Animation</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="skipIntroToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <!-- Mute All Sounds Toggle -->
                <div class="setting-item">
                    <label for="muteAllSoundsToggle" class="setting-label">Mute All Sounds</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="muteAllSoundsToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <!-- Custom Keypad Toggle -->
                <div class="setting-item">
                    <label for="useCustomKeypadToggle" class="setting-label">Use Custom Keypad</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="useCustomKeypadToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="debug-section">
                <div class="debug-header">
                    <h4>Debug Log</h4>
                    <button id="copyDebugBtn" class="copy-debug-btn">
                        <span class="material-symbols-rounded">content_copy</span>
                    </button>
                </div>
                <textarea id="debugArea" readonly></textarea>
            </div>
        </div>

        <!-- Help/Info Panel -->
        <div id="helpPanel" class="help-panel">
            <div class="help-header">
                <div class="help-header-title">
                    <img src="Picklepairs.png" alt="Pickle Pairs Logo" class="help-logo">
                    <h2>Pickle Pairs Guide</h2>
                </div>
                <button id="closeHelpBtn" class="help-close-btn">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            
            <!-- Dancing pickle guide -->
            <div class="dancing-pickle-guide" id="dancingPickleGuide" title="Jump to Pro Tips">💡🥒</div>
            
            <div class="help-section">
                <h3><span class="feature-section-icon">🥒</span>Welcome to the Pickle Party! 🥒</h3>
                <p>Pickle Pairs is your go-to app for organizing <span class="pickle-highlight">dill-ightful</span> pickleball matches! Whether you're running a casual neighborhood round-robin or a competitive tournament, we've got you covered with our <span class="pickle-highlight">court-smart</span> matchmaking system.</p>
                <p>No more "kitchen" violations when it comes to pairing players - we ensure everyone gets a fair chance to play with and against different partners throughout your event!</p>
            </div>
            
            <div class="help-section">
                <h3><span class="feature-section-icon">🥒</span>Getting Started</h3>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">edit_note</span>Add Your Picklers</h4>
                    <p>Enter player names in the text area at the top, separated by commas or line breaks. Our player counter will keep track of how many picklers you've added.</p>
                    <div class="feature-visual">
                        <div class="ui-example">
                            <span class="material-symbols-rounded">edit_note</span>
                            <div>
                                <textarea disabled style="width: 90%; height: 40px; padding: 5px; font-size: 12px;">John, Mary, Steve, Jessica, David</textarea>
                                <div style="margin-top: 5px;"><strong>Player Count: 5</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">grid_view</span>Set Court Count</h4>
                    <p>Select how many courts you have available using the dropdown menu. This helps us optimize match scheduling.</p>
                    <div class="feature-visual">
                        <div class="ui-example">
                            <div style="display: inline-block; padding: 5px; border: 1px solid #ccc; border-radius: 4px; background: white;">
                                <span style="margin-right: 10px;">Courts:</span>
                                <select disabled style="padding: 3px;">
                                    <option>3 Courts</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">sports_tennis</span>Start Your Tournament</h4>
                    <p>Click the green "START TOURNAMENT" button to generate your first round of perfectly balanced matches!</p>
                    <div class="feature-visual">
                        <div class="button-example success">
                            <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">sports_tennis</span>
                            START TOURNAMENT
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="help-section">
                <h3><span class="feature-section-icon">🏆</span>Key Features</h3>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">diversity_3</span>Smart Matchmaking</h4>
                    <p>Our algorithm ensures players get unique partners each round and face new opponents until all combinations are exhausted - giving everyone a <span class="pickle-highlight">fair dink</span> at playing with everyone else!</p>
                    <p>The algorithm also intelligently handles <span class="pickle-highlight">late arrivals</span> and players who need to step out temporarily, automatically adjusting pairings to maintain balance.</p>
                    <div class="feature-visual">
                        <div style="width: 100%; text-align: center; padding: 5px; font-size: 13px;">
                            <div style="font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Round 1</div>
                            <div style="display: flex; justify-content: space-around; margin-bottom: 5px;">
                                <div>Court 1: <strong>John & Mary</strong> vs <strong>Steve & Jessica</strong></div>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 10px;">Player David sits out this round</div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">scoreboard</span>Match Scoring</h4>
                    <p>Enter scores after each match to track performance. Winners record their "Pickle Points" (the points they scored), and we'll handle the rest!</p>
                    <div class="feature-visual">
                        <div style="width: 100%; padding: 5px;">
                            <div style="margin-bottom: 10px; font-weight: bold; color: #4CAF50; text-align: center; display: flex; align-items: center; justify-content: center;">
                                <span class="material-symbols-rounded" style="margin-right: 5px;">emoji_events</span>
                                WINNERS
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; background-color: rgba(76, 175, 80, 0.15); padding: 8px; border-radius: 4px; border-left: 4px solid #4CAF50;">
                                <div style="font-weight: bold;">John & Mary</div>
                                <input type="text" value="11" disabled style="width: 40px; text-align: center; border: 2px solid #4CAF50; border-radius: 4px; padding: 3px; background-color: white;">
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px;">
                                <div>Steve & Jessica</div>
                                <input type="text" disabled value="5" style="width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 3px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">edit</span>Editing Match Results</h4>
                    <p>Made a scoring mistake and in a <span class="pickle-highlight">pickle</span>? No worries! You can easily edit match results after they're completed.</p>
                    <div class="feature-visual">
                        <div style="width: 100%; padding: 5px;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-symbols-rounded" style="color: #FF9800;">edit</span>
                                    <div style="font-size: 13px;">Simply click on any completed match score to edit it</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-symbols-rounded" style="color: #4CAF50;">check_circle</span>
                                    <div style="font-size: 13px;">The leaderboard and stats update automatically</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="material-symbols-rounded" style="color: #F44336;">warning</span>
                                    <div style="font-size: 13px;">Can't find a match to edit? Check the Match History</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">emoji_events</span>Leaderboard</h4>
                    <p>Track player progress with our dynamic leaderboard - complete with cool sound effects and animations that would make any pickleball paddle proud!</p>
                    <div class="feature-visual">
                        <div style="width: 100%; display: flex; justify-content: space-around;">
                            <div class="button-example primary">
                                <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">emoji_events</span>
                                LEADERBOARD
                            </div>
                            <div class="button-example" style="background-color: #FF9800;">
                                <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">emoji_events</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">history</span>Match History</h4>
                    <p>Review all completed matches in chronological order - perfect for settling those "but I'm sure we won!" debates.</p>
                    <div class="feature-visual">
                        <div class="button-example">
                            <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">history</span>
                            MATCH HISTORY
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">people</span>Player Management</h4>
                    <p>Use the floating player list to track who's playing and who's sitting out. You can manually toggle players to "Active" or "Sitting Out" for a round if they need a break or have to leave early. Perfect for managing those <span class="pickle-highlight">pickle fatigue</span> moments!</p>
                    <div class="feature-visual">
                        <div style="width: 100%; max-width: 360px; margin: 0 auto; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <!-- Header -->
                            <div style="background-color: #2196F3; color: white; padding: 10px; text-align: center; font-weight: bold;">
                                Players
                            </div>
                            <!-- Player table header -->
                            <div style="display: flex; background-color: #2196F3; color: white; padding: 8px 10px;">
                                <div style="flex: 1; font-weight: bold; font-size: 14px;">NAME</div>
                                <div style="flex: 2; font-weight: bold; font-size: 14px;">STATUS</div>
                            </div>
                            <!-- Player a -->
                            <div style="display: flex; align-items: center; padding: 8px 10px; background-color: white; border-bottom: 1px solid #eee;">
                                <div style="flex: 1; font-size: 16px; font-weight: 700; color: #1565C0;">a</div>
                                <div style="flex: 2; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="position: relative; display: inline-block; width: 40px; height: 22px; margin-right: 8px;">
                                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(66, 184, 131, 0.3); border-radius: 34px;"></div>
                                            <div style="position: absolute; height: 18px; width: 18px; left: 22px; bottom: 2px; background-color: white; border-radius: 50%;"></div>
                                        </div>
                                        <span style="background-color: rgba(66, 184, 131, 0.2); color: #2E7D32; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; text-transform: uppercase;">Active</span>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <button style="background-color: #2196F3; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                            <span class="material-symbols-rounded" style="font-size: 16px;">edit</span>
                                        </button>
                                        <button style="background-color: #FF6B6B; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                            <span class="material-symbols-rounded" style="font-size: 16px;">delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Player b -->
                            <div style="display: flex; align-items: center; padding: 8px 10px; background-color: #f5f5f5; border-bottom: 1px solid #eee;">
                                <div style="flex: 1; font-size: 16px; font-weight: 700; color: #1565C0;">b</div>
                                <div style="flex: 2; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="position: relative; display: inline-block; width: 40px; height: 22px; margin-right: 8px;">
                                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 107, 107, 0.3); border-radius: 34px;"></div>
                                            <div style="position: absolute; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%;"></div>
                                        </div>
                                        <span style="background-color: rgba(255, 107, 107, 0.2); color: #D32F2F; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; text-transform: uppercase;">Sitting Out</span>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <button style="background-color: #2196F3; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                            <span class="material-symbols-rounded" style="font-size: 16px;">edit</span>
                                        </button>
                                        <button style="background-color: #FF6B6B; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                            <span class="material-symbols-rounded" style="font-size: 16px;">delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Player c -->
                            <div style="display: flex; align-items: center; padding: 8px 10px; background-color: white; border-bottom: 1px solid #eee;">
                                <div style="flex: 1; font-size: 16px; font-weight: 700; color: #1565C0;">c</div>
                                <div style="flex: 2; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="position: relative; display: inline-block; width: 40px; height: 22px; margin-right: 8px;">
                                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(66, 184, 131, 0.3); border-radius: 34px;"></div>
                                            <div style="position: absolute; height: 18px; width: 18px; left: 22px; bottom: 2px; background-color: white; border-radius: 50%;"></div>
                                        </div>
                                        <span style="background-color: rgba(66, 184, 131, 0.2); color: #2E7D32; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; text-transform: uppercase;">Active</span>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <button style="background-color: #2196F3; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                            <span class="material-symbols-rounded" style="font-size: 16px;">edit</span>
                                        </button>
                                        <button style="background-color: #FF6B6B; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                            <span class="material-symbols-rounded" style="font-size: 16px;">delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">save</span>Import/Export Data</h4>
                    <p>Save your tournament data to continue later or transfer to another device. Not even a <span class="pickle-highlight">kitchen fault</span> can erase your progress!</p>
                    <div class="feature-visual">
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <div class="button-example">
                                <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">download</span>
                                EXPORT DATA
                            </div>
                            <div class="button-example">
                                <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">upload</span>
                                IMPORT DATA
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">photo_camera</span>Capture Images</h4>
                    <p>Take snapshots of your leaderboard and match history to share with the group or for posterity. Pictures or it didn't happen, right?</p>
                    <div class="feature-visual">
                        <div class="button-example">
                            <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">photo_camera</span>
                            CAPTURE ALL
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="help-section">
                <h3><span class="feature-section-icon">📊</span>Leaderboard Rankings Explained</h3>
                <p>Our leaderboard tracks multiple metrics to give a comprehensive view of player performance. Swipe through each ranking mode to understand how they work:</p>
                
                <div class="ranking-carousel">
                    <div class="ranking-slide active" id="slide-0">
                        <h4 class="ranking-title"><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #FFD700; margin-right: 5px;">emoji_events</span>Victory Points <span class="pickle-highlight">(Default)</span></h4>
                        <div class="ranking-description">
                            <p>The primary ranking method in Pickle Pairs.</p>
                            <ul>
                                <li>1 point awarded to each player on the winning team</li>
                                <li>Players with most Victory Points rank highest</li>
                                <li>Ties are broken by: Win %, then Pickle Points, then Differential, then Average</li>
                            </ul>
                            <p><strong>Best for:</strong> Fair overall rankings that reward consistent winning.</p>
                            <div class="feature-visual">
                                <div style="font-size: 13px; width: 100%;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 3px;">
                                        <span>Name</span>
                                        <span>Victory Pts</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>1. Mary</span>
                                        <span>5</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>2. John</span>
                                        <span>4</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>3. Steve</span>
                                        <span>3</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ranking-slide" id="slide-1">
                        <h4 class="ranking-title"><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #FF9800; margin-right: 5px;">scoreboard</span>Pickle Points</h4>
                        <div class="ranking-description">
                            <p>Total points scored across all games.</p>
                            <ul>
                                <li>Rewards aggressive offensive play and high scoring</li>
                                <li>Players with most total points rank highest</li>
                                <li>Ties are broken by: Victory Points, then Win %, then Differential</li>
                            </ul>
                            <p><strong>Best for:</strong> Highlighting offensive players who consistently rack up points.</p>
                            <div class="feature-visual">
                                <div style="font-size: 13px; width: 100%;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 3px;">
                                        <span>Name</span>
                                        <span>Pickle Pts</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>1. Steve</span>
                                        <span>42</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>2. Mary</span>
                                        <span>39</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>3. John</span>
                                        <span>35</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ranking-slide" id="slide-2">
                        <h4 class="ranking-title"><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #2196F3; margin-right: 5px;">percent</span>Win Percentage</h4>
                        <div class="ranking-description">
                            <p>Percentage of matches won relative to total matches played.</p>
                            <ul>
                                <li>Calculated as: (Wins ÷ Total Games) × 100%</li>
                                <li>Players with highest win % rank highest</li>
                                <li>Ties are broken by: Victory Points, then Pickle Points</li>
                            </ul>
                            <p><strong>Best for:</strong> Comparing players who've played different numbers of games.</p>
                            <div class="feature-visual">
                                <div style="font-size: 13px; width: 100%;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 3px;">
                                        <span>Name</span>
                                        <span>Win %</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>1. Mary</span>
                                        <span>83%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>2. David</span>
                                        <span>75%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>3. John</span>
                                        <span>67%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ranking-slide" id="slide-3">
                        <h4 class="ranking-title"><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #9C27B0; margin-right: 5px;">functions</span>Pickle Points Average</h4>
                        <div class="ranking-description">
                            <p>Average points scored in each game.</p>
                            <ul>
                                <li>Calculated as: Total Points ÷ Games Played</li>
                                <li>Players with highest average rank highest</li>
                                <li>Ties are broken by: Total Points, then Victory Points</li>
                            </ul>
                            <p><strong>Best for:</strong> Finding consistently high scorers regardless of win count.</p>
                            <div class="feature-visual">
                                <div style="font-size: 13px; width: 100%;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 3px;">
                                        <span>Name</span>
                                        <span>Pt Avg</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>1. Jessica</span>
                                        <span>8.5</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>2. Steve</span>
                                        <span>8.4</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>3. Mary</span>
                                        <span>7.8</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ranking-slide" id="slide-4">
                        <h4 class="ranking-title"><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #F44336; margin-right: 5px;">trending_up</span>Pickle Differential</h4>
                        <div class="ranking-description">
                            <p>The difference between points scored and points allowed.</p>
                            <ul>
                                <li>Calculated as: Total Points Scored − Total Points Allowed</li>
                                <li>Players with highest differential rank highest</li>
                                <li>Positive number = scored more than allowed</li>
                                <li>Negative number = allowed more than scored</li>
                                <li>Ties are broken by: Victory Points, then Win %</li>
                            </ul>
                            <p><strong>Best for:</strong> Balancing offensive scoring with defensive skill.</p>
                            <div class="feature-visual">
                                <div style="font-size: 13px; width: 100%;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 3px;">
                                        <span>Name</span>
                                        <span>Differential</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>1. Mary</span>
                                        <span>+18</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                        <span>2. John</span>
                                        <span>+12</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>3. David</span>
                                        <span>+6</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ranking-slide" id="slide-5">
                        <h4 class="ranking-title"><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">tune</span>Custom Sorting</h4>
                        <div class="ranking-description">
                            <p>Create your own ranking by using the sort buttons at the top of the leaderboard.</p>
                            <ul>
                                <li>Click any metric button to sort the leaderboard by that stat</li>
                                <li>Great for tournament variations or special challenges</li>
                                <li>Podium will update to reflect your custom sort</li>
                            </ul>
                            <p><strong>Best for:</strong> Adding variety to your tournament or focusing on specific skills.</p>
                            <div class="feature-visual">
                                <div style="width: 100%; padding: 5px;">
                                    <div style="font-weight: bold; margin-bottom: 8px;">Sort Buttons:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;">
                                        <div class="button-example" style="font-size: 12px;">Victory Points</div>
                                        <div class="button-example" style="font-size: 12px;">Pickle Points</div>
                                        <div class="button-example" style="font-size: 12px;">Win %</div>
                                        <div class="button-example" style="font-size: 12px;">Pt Avg</div>
                                        <div class="button-example" style="font-size: 12px;">Differential</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ranking-navigation">
                        <button class="ranking-btn prev-btn" onclick="navigateRankingSlide(-1)">
                            <span class="material-symbols-rounded">chevron_left</span>
                        </button>
                        
                        <div class="ranking-dots">
                            <span class="ranking-dot active" onclick="showRankingSlide(0)"></span>
                            <span class="ranking-dot" onclick="showRankingSlide(1)"></span>
                            <span class="ranking-dot" onclick="showRankingSlide(2)"></span>
                            <span class="ranking-dot" onclick="showRankingSlide(3)"></span>
                            <span class="ranking-dot" onclick="showRankingSlide(4)"></span>
                            <span class="ranking-dot" onclick="showRankingSlide(5)"></span>
                        </div>
                        
                        <button class="ranking-btn next-btn" onclick="navigateRankingSlide(1)">
                            <span class="material-symbols-rounded">chevron_right</span>
                        </button>
                    </div>
                </div>
                
                <p>The <span class="pickle-highlight">top three picklers</span> get the honor of standing on our virtual podium with gold, silver, and bronze medals!</p>
                <div class="feature-visual">
                    <div style="display: flex; justify-content: center; align-items: flex-end; width: 100%; padding: 10px;">
                        <div style="text-align: center; margin: 0 10px; padding: 5px 10px; background-color: #C0C0C0; height: 40px; display: flex; flex-direction: column; justify-content: flex-end; border-radius: 4px 4px 0 0;">
                            <div style="font-size: 20px;">🥈</div>
                            <div style="font-weight: bold;">John</div>
                        </div>
                        <div style="text-align: center; margin: 0 10px; padding: 5px 10px; background-color: #FFD700; height: 60px; display: flex; flex-direction: column; justify-content: flex-end; border-radius: 4px 4px 0 0;">
                            <div style="font-size: 20px;">🥇</div>
                            <div style="font-weight: bold;">Mary</div>
                        </div>
                        <div style="text-align: center; margin: 0 10px; padding: 5px 10px; background-color: #CD7F32; height: 30px; display: flex; flex-direction: column; justify-content: flex-end; border-radius: 4px 4px 0 0;">
                            <div style="font-size: 20px;">🥉</div>
                            <div style="font-weight: bold;">Steve</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="help-section">
                <h3><span class="feature-section-icon">💡</span>Pro Tips</h3>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">keyboard</span>Quick Score Entry</h4>
                    <p>Use the number keypad for faster score entry - just click the score box and type the winner's points!</p>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">update</span>Real-time Adjustments</h4>
                    <p>Need to handle players arriving late or leaving early? No problem! Use the player's panel when toggling a player's status to apply changes to the next round.</p>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">navigate_next</span>Navigation Shortcuts</h4>
                    <p>Use the Arrow buttons to quickly scroll to your active matches or the top of the page.</p>
                    <div class="feature-visual">
                        <div style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div class="button-example" style="border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; padding: 0;">
                                    <span class="material-symbols-rounded">arrow_upward</span>
                                </div>
                                <div style="font-size: 12px; margin-top: 5px;">Top</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div class="button-example" style="border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; padding: 0;">
                                    <span class="material-symbols-rounded">arrow_downward</span>
                                </div>
                                <div style="font-size: 12px; margin-top: 5px;">Current Round</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-feature">
                    <h4><span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; color: #4CAF50; margin-right: 5px;">volume_up</span>Sound Settings</h4>
                    <p>Toggle sound effects for the intro and leaderboard using the sound icon buttons. Customize your audio preferences in the settings menu.</p>
                </div>
            </div>
            
            <div class="help-footer">
                <p>Pickle Pairs - Doing Doubles Right since 2025<br>Created with ❤️ and a passion for pickleball</p>
                <img src="simplelogot.png" alt="Simple Logo" style="width: 30px; margin-top: 10px;">
            </div>
        </div>
    </div>

    <script>
        // Intro animation with audio
        document.addEventListener('DOMContentLoaded', function() {
            const introContainer = document.getElementById('intro-animation');
            const introContent = introContainer.querySelector('.intro-content');
            const startButton = document.getElementById('startButton');
            const introAudio = document.getElementById('introAudio');
            const toggleMainAudioBtn = document.getElementById('toggleMainAudioBtn');
            
            // Set default volume to 30% for both audio elements
            introAudio.volume = 0.3;
            document.getElementById('leaderboardAudio').volume = 0.3;
            
            // Setup audio state variables first
            let isMainAudioMuted = localStorage.getItem('isMainAudioMuted') === 'true';
            let isLeaderboardMuted = isMainAudioMuted; // Always keep both in sync
            localStorage.setItem('isLeaderboardAudioMuted', isMainAudioMuted.toString()); // Ensure they stay synced in localStorage too
            
            // Add debug logging for settings values
            console.log('Initial settings values:', {
                isMainAudioMuted,
                isLeaderboardMuted,
                skipIntro: localStorage.getItem('skipIntro') === 'true',
                muteAllSounds: localStorage.getItem('muteAllSounds') === 'true',
                useCustomKeypad: localStorage.getItem('useCustomKeypad') !== 'false'
            });
            
            // Initialize settings toggles
            const skipIntroToggle = document.getElementById('skipIntroToggle');
            const muteAllSoundsToggle = document.getElementById('muteAllSoundsToggle');
            const useCustomKeypadToggle = document.getElementById('useCustomKeypadToggle');
            const saveAsPictureBtn = document.getElementById('saveAsPictureBtn');
            
            // Check localStorage for settings
            let skipIntro = localStorage.getItem('skipIntro') === 'true';
            // muteAllSounds will control ALL audio including music and sound effects (sFX elements)
            let muteAllSounds = localStorage.getItem('muteAllSounds') === 'true';
            let useCustomKeypad = localStorage.getItem('useCustomKeypad') !== 'false';
            
            // Set initial toggle states
            skipIntroToggle.checked = skipIntro;
            muteAllSoundsToggle.checked = muteAllSounds;
            useCustomKeypadToggle.checked = useCustomKeypad;
            
            // Apply skip intro setting if enabled
            if (skipIntro) {
                introContainer.style.display = 'none';
                if (!window.guideArrowInitialized) {
                    window.guideArrowInitialized = true;
                    setTimeout(() => {
                        showGuideArrow();
                    }, 200);
                }
            }
            
            // Apply mute all sounds setting if enabled
            if (muteAllSounds) {
                // Set muted state for both audio elements
                isMainAudioMuted = true;
                isLeaderboardMuted = true; // Keep both in sync
                
                // Update localStorage
                localStorage.setItem('isMainAudioMuted', 'true');
                localStorage.setItem('isLeaderboardAudioMuted', 'true');
                
                // Update UI
                toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_off';
                toggleMainAudioBtn.classList.add('muted');
                toggleMainAudioBtn.setAttribute('data-tooltip', 'Turned off in settings - gear icon');
                
                // Immediately stop any playing audio for iOS/Safari compatibility
                introAudio.pause();
                introAudio.currentTime = 0;
                
                const leaderboardAudio = document.getElementById('leaderboardAudio');
                leaderboardAudio.pause();
                leaderboardAudio.currentTime = 0;
            }
            
            // Add event listeners for settings toggles
            skipIntroToggle.addEventListener('change', function() {
                skipIntro = this.checked;
                localStorage.setItem('skipIntro', skipIntro.toString());
                
                // Log to debug area
                const debugArea = document.getElementById('debugArea');
                if (debugArea) {
                    const timestamp = new Date().toISOString();
                    debugArea.value += `${timestamp} - Skip intro setting changed to: ${skipIntro}\n`;
                    // Scroll to bottom
                    debugArea.scrollTop = debugArea.scrollHeight;
                }
                
                // Clear console log for debugging
                console.log(`Skip intro toggled to: ${skipIntro}`);
                console.log('Current localStorage value:', localStorage.getItem('skipIntro'));
            });
            
            muteAllSoundsToggle.addEventListener('change', function() {
                muteAllSounds = this.checked;
                localStorage.setItem('muteAllSounds', muteAllSounds.toString());
                
                // Clear console log for debugging
                console.log(`Mute all sounds toggled to: ${muteAllSounds}`);
                console.log('Current localStorage value:', localStorage.getItem('muteAllSounds'));
                
                // Update audio states based on this master setting
                if (muteAllSounds) {
                    // Save current states before muting everything
                    localStorage.setItem('previousMainAudioState', isMainAudioMuted.toString());
                    
                    console.log('Saved previous audio state:', isMainAudioMuted);
                    
                    // Mute all audio elements
                    isMainAudioMuted = true;
                    isLeaderboardMuted = true; // Keep both in sync
                    
                    // Update localStorage
                    localStorage.setItem('isMainAudioMuted', 'true');
                    localStorage.setItem('isLeaderboardAudioMuted', 'true');
                    
                    // Update UI
                    toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_off';
                    toggleMainAudioBtn.classList.add('muted');
                    toggleMainAudioBtn.setAttribute('data-tooltip', 'Turned off in settings - gear icon');
                    
                    // Immediately stop any playing audio for iOS/Safari compatibility
                    introAudio.pause();
                    introAudio.currentTime = 0;
                    
                    const leaderboardAudio = document.getElementById('leaderboardAudio');
                    leaderboardAudio.pause();
                    leaderboardAudio.currentTime = 0;
                } else {
                    // Restore previous audio states - now both will be the same
                    const previousMainAudioState = localStorage.getItem('previousMainAudioState') === 'true';
                    
                    console.log('Restoring previous audio state:', previousMainAudioState);
                    
                    // Set both audio states to the same value
                    isMainAudioMuted = previousMainAudioState;
                    isLeaderboardMuted = previousMainAudioState; // Keep both in sync
                    
                    // Update localStorage
                    localStorage.setItem('isMainAudioMuted', isMainAudioMuted.toString());
                    localStorage.setItem('isLeaderboardAudioMuted', isLeaderboardMuted.toString());
                    
                    // Update main audio UI
                    toggleMainAudioBtn.removeAttribute('data-tooltip');
                    if (isMainAudioMuted) {
                        toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_off';
                        toggleMainAudioBtn.classList.add('muted');
                    } else {
                        toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
                        toggleMainAudioBtn.classList.remove('muted');
                    }
                }
                
                // Log to debug area
                const debugArea = document.getElementById('debugArea');
                if (debugArea) {
                    const timestamp = new Date().toISOString();
                    debugArea.value += `${timestamp} - Mute all sounds setting changed to: ${muteAllSounds}\n`;
                    // Scroll to bottom
                    debugArea.scrollTop = debugArea.scrollHeight;
                }
                
                // Show toast for user feedback
                showToast(`All sounds (music & sound effects) ${muteAllSounds ? 'muted' : 'enabled'}`, "info", 2000);
            });
            
            // Custom Keypad Toggle Event Listener
            useCustomKeypadToggle.addEventListener('change', function() {
                useCustomKeypad = this.checked;
                localStorage.setItem('useCustomKeypad', useCustomKeypad.toString());
                
                // Clear console log for debugging
                console.log(`Use custom keypad toggled to: ${useCustomKeypad}`);
                console.log('Current localStorage value:', localStorage.getItem('useCustomKeypad'));
                
                // Update score input fields
                updateScoreInputsReadonly(useCustomKeypad);
                
                // Log to debug area
                const debugArea = document.getElementById('debugArea');
                if (debugArea) {
                    const timestamp = new Date().toISOString();
                    debugArea.value += `${timestamp} - Custom keypad setting changed to: ${useCustomKeypad}\n`;
                    // Scroll to bottom
                    debugArea.scrollTop = debugArea.scrollHeight;
                }
                
                // Show toast for user feedback
                showToast(`Custom keypad ${useCustomKeypad ? 'enabled' : 'disabled - using device keyboard'}`, "info", 2000);
            });
            
            // Update toggle main audio button click handler to mute/unmute all music at once
            toggleMainAudioBtn.addEventListener('click', function() {
                if (muteAllSounds) {
                    // Show a toast notification
                    showToast("Sound is disabled in settings. Check the gear icon to enable.", "info", 3000);
                    return;
                }
                
                // Toggle both audio sources at once
                isMainAudioMuted = !isMainAudioMuted;
                isLeaderboardMuted = isMainAudioMuted; // Keep both in sync
                
                // Update localStorage for both
                localStorage.setItem('isMainAudioMuted', isMainAudioMuted.toString());
                localStorage.setItem('isLeaderboardAudioMuted', isLeaderboardMuted.toString());
                
                // Log for debugging
                console.log(`All music muted toggled to: ${isMainAudioMuted}`);
                
                if (isMainAudioMuted) {
                    // Change icon to muted
                    toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_off';
                    toggleMainAudioBtn.classList.add('muted');
                    
                    // Pause both audio elements
                    introAudio.pause();
                    introAudio.currentTime = 0;
                    leaderboardAudio.pause();
                    leaderboardAudio.currentTime = 0;
                    
                    // Show toast notification
                    showToast("All music muted", "info", 2000);
                } else {
                    // Change icon to unmuted
                    toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
                    toggleMainAudioBtn.classList.remove('muted');
                    
                    // Play the appropriate audio based on which screen is visible
                    if (document.getElementById('podiumDisplay').classList.contains('active')) {
                        safePlayAudio(leaderboardAudio);
                    } else if (introContainer && !introContainer.classList.contains('animate-out') && introContainer.style.display !== 'none') {
                        safePlayAudio(introAudio);
                    }
                    
                    // Show toast notification
                    showToast("All music unmuted", "info", 2000);
                }
            });
            
            // Setup logo flip click behavior
            const logoFlipContainers = document.querySelectorAll('.logo-flip-container');
            logoFlipContainers.forEach(container => {
                // We'll keep a simpler implementation that works well with CSS hover
                container.addEventListener('click', function(e) {
                    // This is primarily for mobile devices
                    // Desktop will use CSS :hover state
                });
            });
            
            // Update toggle button icon based on mute state
            if (isMainAudioMuted) {
                toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_off';
                toggleMainAudioBtn.classList.add('muted');
            } else {
                toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
                toggleMainAudioBtn.classList.remove('muted');
            }
            
            // Start the intro animation immediately on page load
            // This will animate in the logo, title, slogan, and button
            setTimeout(function() {
                introContent.classList.add('animate-in');
            }, 100);
            
            // Add click event to start button to begin the transition to the main app
            startButton.addEventListener('click', function() {
                // Re-enable scrolling immediately
                toggleScrollLock(false);
                
                // Add the clicked class to trigger the button animation
                startButton.classList.add('clicked');
                
                // Start the audio only if not muted
                if (!isMainAudioMuted) {
                    // Volume is already set to 0.3 (30%) on initialization
                    safePlayAudio(introAudio);
                    
                    // Start fading audio after 7 seconds
                    setTimeout(() => {
                        // Gradually fade out audio over 3 seconds
                        fadeOutIntroAudio();
                    }, 7000);
                }
                
                // Trigger animation out after a short delay to allow button animation to complete
                setTimeout(function() {
                    introContainer.classList.add('animate-out');
                    
                    // Remove the intro container from DOM after animation completes
                    setTimeout(function() {
                        introContainer.style.display = 'none';
                        
                        // Show guide arrow after intro animation completes
                        if (!window.guideArrowInitialized) {
                            window.guideArrowInitialized = true;
                            setTimeout(() => {
                                showGuideArrow();
                            }, 200);
                        }
                    }, 1000); // Should match the CSS transition duration
                }, 600);
            });
            
            // Leaderboard audio functionality
            const leaderboardAudio = document.getElementById('leaderboardAudio');
            const showPodiumBtn = document.getElementById('showPodiumBtn');
            const floatingLeaderboardBtn = document.getElementById('floatingLeaderboardBtn');
            const closePodiumBtn = document.getElementById('closePodiumBtn');
            
            // Function to quickly fade out intro audio
            function fadeOutIntroAudio(immediate = false) {
                if (introAudio.paused) return;
                
                const duration = immediate ? 50 : 300; // Faster fade if immediate is true
                const decrement = immediate ? 0.05 : 0.02; // Adjusted for 30% starting volume
                
                // Fade out intro audio
                const fadeInterval = setInterval(() => {
                    if (introAudio.volume > 0.05) {
                        introAudio.volume -= decrement;
                    } else {
                        clearInterval(fadeInterval);
                        introAudio.pause();
                        introAudio.currentTime = 0;
                        introAudio.volume = 0.3; // Reset to 30% volume for future use
                    }
                }, duration);
            }
            
            // Function to play audio that works around iOS/Safari limitations
            function safePlayAudio(audioElement) {
                // Only attempt to play if the audio isn't muted
                if (audioElement && !audioElement.paused) {
                    // Already playing, don't interrupt
                    return Promise.resolve();
                }
                
                // Use a user interaction promise to play audio
                const playPromise = audioElement.play();
                
                // Handle the promise to catch and log any errors
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Audio playback was prevented by the browser:', error);
                        // On iOS, we might need to handle this case differently
                        if (error.name === 'NotAllowedError') {
                            // Consider showing a "Tap to enable audio" message on iOS
                            console.log('Safari/iOS blocked autoplay. User interaction required.');
                        }
                    });
                }
                
                return playPromise;
            }
            
            // Function to safely play a sound effect (for future SFX)
            function playSoundEffect(sfxId) {
                // Don't play if all sounds are muted
                if (muteAllSounds) return;
                
                // Get the sound effect element
                const sfxElement = document.getElementById(sfxId);
                if (!sfxElement) {
                    console.warn(`Sound effect with id ${sfxId} not found`);
                    return;
                }
                
                // Reset and play
                sfxElement.currentTime = 0;
                
                // Use a user interaction promise to play audio
                const playPromise = sfxElement.play();
                
                // Handle the promise to catch and log any errors
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('SFX playback was prevented by the browser:', error);
                        // On iOS, we might need to handle this case differently
                        if (error.name === 'NotAllowedError') {
                            console.log('Safari/iOS blocked autoplay. User interaction required.');
                        }
                    });
                }
                
                return playPromise;
            }
            
            // Function to play leaderboard audio
            function playLeaderboardAudio() {
                // First fade out intro audio if it's playing
                fadeOutIntroAudio();
                
                if (!isMainAudioMuted) { // Use isMainAudioMuted since both are in sync now
                    // Volume is already set to 0.3 (30%) on initialization
                    leaderboardAudio.currentTime = 0; // Reset to beginning
                    safePlayAudio(leaderboardAudio);
                }
            }
            
            // Function to stop leaderboard audio with fade out
            function stopLeaderboardAudio() {
                if (leaderboardAudio.paused) return;
                
                // For iOS/Safari compatibility, just pause immediately
                leaderboardAudio.pause();
                leaderboardAudio.currentTime = 0;
            }
            
            // Play audio when leaderboard is opened
            showPodiumBtn.addEventListener('click', function() {
                console.log("showPodiumBtn clicked");
                showPodium();
                playLeaderboardAudio();
            });
            
            floatingLeaderboardBtn.addEventListener('click', function() {
                console.log("floatingLeaderboardBtn clicked");
                showPodium();
                playLeaderboardAudio();
            });
            
            // Stop audio when leaderboard is closed
            closePodiumBtn.addEventListener('click', stopLeaderboardAudio);
            
            // Function to update main audio button to reflect leaderboard audio state
            function updateMainAudioButtonForPodium() {
                if (isLeaderboardMuted) {
                    toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_off';
                    toggleMainAudioBtn.classList.add('muted');
                } else {
                    toggleMainAudioBtn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
                    toggleMainAudioBtn.classList.remove('muted');
                }
            }
            
            // Function to show toast notifications
            function showToast(message, type, duration) {
                const toast = document.createElement('div');
                toast.classList.add('toast', `toast-${type}`);
                toast.innerHTML = `
                    <div class="toast-icon">${getToastIcon(type)}</div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close">×</button>
                `;
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.classList.remove('active');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                });
                toast.classList.add('active');
                document.getElementById('toastContainer').appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('active');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, duration);
            }
            
            // Function to get toast icon based on type
            function getToastIcon(type) {
                switch (type) {
                    case 'success': return '✅';
                    case 'error': return '❌';
                    case 'info': return 'ℹ️';
                    case 'warning': return '⚠️';
                    default: return '🔔';
                }
            }
        });
        
        // Function to show the guide arrow and handle its behavior
        // Use a module pattern to prevent multiple calls in quick succession
        const guideArrowHandler = (function() {
            let isShowing = false;
            let lastShownTime = 0;
            const COOLDOWN_TIME = 500; // ms
            
            return function showGuideArrow() {
                console.log("showGuideArrow called");
                
                // Prevent multiple calls within cooldown period
                const now = Date.now();
                if (isShowing || (now - lastShownTime < COOLDOWN_TIME)) {
                    console.log("Guide arrow already showing or called too soon, skipping");
                    return;
                }
                
                isShowing = true;
                lastShownTime = now;
                
                // Remove any existing guide arrow to avoid duplicates
                const existingGuideArrow = document.getElementById('guideArrow');
                if (existingGuideArrow) {
                    existingGuideArrow.remove();
                }
                
                // Recreate the guide arrow
                const guideArrowHTML = `
                    <div id="guideArrow" class="guide-arrow">
                        <div class="guide-arrow-content">
                            <span class="guide-pickle">🥒</span>
                            <span class="guide-arrow-point material-symbols-rounded">arrow_downward</span>
                        </div>
                        <p class="guide-text">Start here!</p>
                    </div>`;
                
                // Append to navigation
                const navigation = document.querySelector('.navigation');
                if (navigation) {
                    navigation.insertAdjacentHTML('beforeend', guideArrowHTML);
                } else {
                    // If navigation doesn't exist, append to body
                    document.body.insertAdjacentHTML('beforeend', guideArrowHTML);
                }
                
                const guideArrow = document.getElementById('guideArrow');
                const playerInput = document.getElementById('playerInput');
                const continueTournamentBtn = document.getElementById('startTournament'); // This is the "CONTINUE PLAYING" button
                
                // Check for visible data in the Round 1 section which indicates loaded data
                const hasVisibleTournament = document.querySelector('.round-container') !== null;
                
                // Check all possible localStorage keys where state might be stored
                let hasStoredData = false;
                try {
                    // Check multiple possible storage keys
                    const stateKeys = ['pickleballCompetitionState', 'tournamentData', 'pickle-state'];
                    
                    for (const key of stateKeys) {
                        const storedData = localStorage.getItem(key);
                        if (storedData) {
                            try {
                                const parsedData = JSON.parse(storedData);
                                if (parsedData && parsedData.players && parsedData.players.length > 0) {
                                    hasStoredData = true;
                                    console.log(`Found stored data in key: ${key}`);
                                    break;
                                }
                            } catch (parseError) {
                                console.error(`Error parsing ${key}:`, parseError);
                            }
                        }
                    }
                } catch (e) {
                    console.error("Error checking tournament data:", e);
                }
                
                // Either visible tournament or stored data means we should point to the continue button
                const hasData = hasVisibleTournament || hasStoredData;
                console.log("Guide arrow check - visible tournament:", hasVisibleTournament, "stored data:", hasStoredData);
                
                let targetElement, targetText;
                
                if (hasData && continueTournamentBtn) {
                    targetElement = continueTournamentBtn;
                    targetText = "Continue!";
                    console.log("Targeting continue button");
                } else if (playerInput) {
                    targetElement = playerInput;
                    targetText = "Start here!";
                    console.log("Targeting player input");
                } else {
                    console.error("Could not find target element for guide arrow");
                    if (guideArrow) guideArrow.remove();
                    isShowing = false;
                    return;
                }
                
                // Keep guideArrow invisible until positioned properly
                if (guideArrow) {
                    guideArrow.style.opacity = '0';
                }
                
                // Position function that will be called on resize and scroll too
                function positionArrow() {
                    if (!targetElement || !guideArrow) {
                        console.error("Target element or guide arrow not found");
                        isShowing = false;
                        return;
                    }
                    
                    const elementRect = targetElement.getBoundingClientRect();
                    const arrowIcon = guideArrow.querySelector('.guide-arrow-point');
                    
                    if (!arrowIcon) {
                        console.error("Arrow icon element not found");
                        isShowing = false;
                        return;
                    }
                    
                    if (hasData) {
                        // For continue playing button - position to left of button, centered vertically
                        guideArrow.style.top = `${elementRect.top + (elementRect.height / 2) - (guideArrow.offsetHeight / 2)}px`;
                        const leftPosition = Math.max(10, elementRect.left - guideArrow.offsetWidth - 20);
                        guideArrow.style.left = `${leftPosition}px`;
                        
                        // Change to east arrow for pointing to the continue button
                        arrowIcon.textContent = "east";
                        arrowIcon.style.animation = "point-arrow-right 1s ease-in-out infinite";
                    } else {
                        // For player input textarea - position above the LEFT side of the input
                        guideArrow.style.top = `${elementRect.top - guideArrow.offsetHeight - 15}px`;
                        guideArrow.style.left = `${elementRect.left + 30}px`;
                        
                        // Use downward arrow for pointing to the text field
                        arrowIcon.textContent = "arrow_downward";
                        arrowIcon.style.animation = "point-arrow-down 1s ease-in-out infinite";
                    }
                    
                    // Update text
                    const textEl = guideArrow.querySelector('.guide-text');
                    if (textEl) {
                        textEl.textContent = targetText;
                    }
                }
                
                // Position first, then make visible to prevent flicker
                setTimeout(() => {
                    if (guideArrow) {
                        positionArrow();
                        
                        // Only add the visible class after positioning
                        setTimeout(() => {
                            guideArrow.classList.add('visible');
                            guideArrow.style.opacity = '';
                        }, 50);
                        
                        // Reposition on window resize and scroll
                        window.addEventListener('resize', positionArrow);
                        window.addEventListener('scroll', positionArrow);
                        
                        // Remove the arrow after 12 seconds
                        setTimeout(() => {
                            if (guideArrow) {
                                guideArrow.classList.remove('visible');
                                // Remove event listeners
                                window.removeEventListener('resize', positionArrow);
                                window.removeEventListener('scroll', positionArrow);
                                
                                // Remove from DOM after animation
                                setTimeout(() => {
                                    if (guideArrow && guideArrow.parentNode) {
                                        guideArrow.remove();
                                    }
                                    isShowing = false;
                                }, 500);
                            }
                        }, 12000);
                    }
                }, 200);
            };
        })();
        
        // Replace all showGuideArrow with guideArrowHandler
        function showGuideArrow() {
            guideArrowHandler();
        }
        
        // Define the scroll to top function and make it globally accessible
        window.scrollTop = function() { 
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Add event listener to the back to top button
        document.getElementById('backToTopBtn').addEventListener('click', scrollTop);
        
        // Add event listener for the debug toggle button
        document.getElementById('toggleDebugBtn').addEventListener('click', function() {
            const debugArea = document.getElementById('debugAreaContainer');
            debugArea.style.display = debugArea.style.display === 'none' ? 'block' : 'none';
        });
        
        // Close settings panel when clicking outside of it
        document.addEventListener('click', function(event) {
            const debugArea = document.getElementById('debugAreaContainer');
            const toggleDebugBtn = document.getElementById('toggleDebugBtn');
            
            // Check if settings panel is visible and click is outside the panel and not on the gear button
            if (debugArea.style.display === 'block' && 
                !debugArea.contains(event.target) && 
                !toggleDebugBtn.contains(event.target)) {
                debugArea.style.display = 'none';
            }
        });
        
        // Add event listener for the info toggle button
        document.getElementById('toggleInfoBtn').addEventListener('click', function() {
            const helpPanel = document.getElementById('helpPanel');
            helpPanel.classList.toggle('active');
        });
        
        // Add event listener for the help panel close button
        document.getElementById('closeHelpBtn').addEventListener('click', function() {
            const helpPanel = document.getElementById('helpPanel');
            helpPanel.classList.remove('active');
        });
        
        // Add event listener for the copy debug button
        document.getElementById('copyDebugBtn').addEventListener('click', function() {
            const debugText = document.getElementById('debugArea').value;
            if (debugText) {
                navigator.clipboard.writeText(debugText)
                    .then(() => {
                        // Visual feedback that copy was successful
                        const copyBtn = document.getElementById('copyDebugBtn');
                        copyBtn.innerHTML = '<span class="material-symbols-rounded">check</span>';
                        setTimeout(() => {
                            copyBtn.innerHTML = '<span class="material-symbols-rounded">content_copy</span>';
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        showToast('Failed to copy debug log to clipboard', 'error');
                    });
            }
        });
        
        // Ranking Carousel Navigation
        let currentSlideIndex = 0;
        const totalSlides = 6; // Total number of ranking slides
        
        // Function to show a specific slide
        function showRankingSlide(index) {
            // Handle index bounds
            if (index < 0) index = totalSlides - 1;
            if (index >= totalSlides) index = 0;
            
            // Update current index
            currentSlideIndex = index;
            
            // Hide all slides
            const slides = document.querySelectorAll('.ranking-slide');
            slides.forEach(slide => slide.classList.remove('active'));
            
            // Show the selected slide
            const selectedSlide = document.getElementById('slide-' + index);
            if (selectedSlide) selectedSlide.classList.add('active');
            
            // Update dots
            const dots = document.querySelectorAll('.ranking-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }
        
        // Function to navigate relative to current slide
        function navigateRankingSlide(direction) {
            showRankingSlide(currentSlideIndex + direction);
        }
        
        // Enable keyboard navigation for ranking slides when help panel is open
        document.addEventListener('keydown', function(e) {
            const helpPanel = document.getElementById('helpPanel');
            if (helpPanel.classList.contains('active')) {
                if (e.key === 'ArrowLeft') {
                    navigateRankingSlide(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateRankingSlide(1);
                }
            }
        });
        
        // Function to capture all content of an element as an image
        function captureElementAsImage(element, filename) {
            // For match history display with a unique approach
            if (element.id === 'matchHistoryDisplay') {
                console.log('Capturing Match History display as image');
                // First get the match content
                const content = element.querySelector('#matchHistoryContent');
                
                // Save original style to restore later
                const originalStyle = element.style.cssText;                
                // Apply special formatting - use match-history-capture-mode class instead of photo-capture-mode
                element.classList.add('match-history-capture-mode');
                console.log('Applied special formatting for capture');
                
                // Save original width/size values to restore later
                const originalWidth = element.style.width;
                const originalHeight = element.style.height;
                
                // Set fixed width for capture that's independent of screen size
                element.style.width = '1200px';  // Set a fixed width large enough for all content
                element.style.height = 'auto';
                element.style.maxWidth = 'none';
                element.style.minWidth = '1200px';
                
                // Check if there's already a title and logo
                const existingTitle = element.querySelector('h2');
                let logoContainer = null;
                
                // Only add logo if it doesn't already exist
                if (!element.querySelector('img[alt="Pickle Pairs Logo"]')) {
                // Add logo to the top of content for the capture
                    logoContainer = document.createElement('div');
                logoContainer.style.textAlign = 'center';
                logoContainer.style.marginBottom = '15px';
                logoContainer.innerHTML = '<img src="simplelogotbase64renamed.png" alt="Pickle Pairs Logo" style="max-width: 150px; margin: 0 auto;" crossorigin="anonymous">';
                    
                    // Add logo before the content but after the title
                    if (existingTitle) {
                        existingTitle.after(logoContainer);
                    } else {
                content.insertBefore(logoContainer, content.firstChild);
                    }
                console.log('Added logo for match history capture');
                }
                
                // Ensure date display is properly styled
                const dateDisplay = element.querySelector('#dateDisplay');
                if (dateDisplay) {
                    dateDisplay.style.textAlign = 'center';
                    dateDisplay.style.margin = '15px auto 25px';
                    dateDisplay.style.width = 'auto';
                } else {
                    // If date display doesn't exist, create it
                    const newDateDisplay = document.createElement('div');
                    newDateDisplay.id = 'dateDisplay';
                    newDateDisplay.style.textAlign = 'center';
                    newDateDisplay.style.margin = '15px auto 25px';
                    newDateDisplay.style.width = 'auto';
                    newDateDisplay.style.fontWeight = 'bold';
                    newDateDisplay.style.fontSize = '18px';
                    newDateDisplay.style.borderBottom = '2px solid var(--primary)';
                    newDateDisplay.style.paddingBottom = '10px';
                    
                    // Format current date
                    const currentDate = new Date();
                    const formattedDate = currentDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    newDateDisplay.textContent = formattedDate;
                    
                    // Add after logo if it exists, otherwise at the beginning of content
                    if (logoContainer && logoContainer.parentNode) {
                        logoContainer.after(newDateDisplay);
                    } else if (content) {
                        const existingLogo = content.querySelector('img[alt="Pickle Pairs Logo"]');
                        if (existingLogo && existingLogo.parentNode) {
                            existingLogo.parentNode.after(newDateDisplay);
                        } else {
                            content.insertBefore(newDateDisplay, content.firstChild);
                        }
                    }
                }
                
                // Hide action column header and cells - these are now handled by CSS
                console.log('Action columns hidden via CSS');
                
                // Hide UI controls
                const closeBtn = document.getElementById('closeMatchHistoryBtn');
                const originalBtnDisplay = {
                    closeBtn: closeBtn ? closeBtn.style.display : '',
                };
                
                if (closeBtn) closeBtn.style.display = 'none';
                console.log('Hidden UI controls for capture');
                
                // Get header references for later restoration
                const tableHeaders = element.querySelectorAll('th');
                const originalHeaders = {};
                
                // Save original header content and styles
                    tableHeaders.forEach((header, index) => {
                        originalHeaders[index] = header.innerHTML;
                    if (header.hasAttribute('style')) {
                        originalHeaders[index + 'style'] = header.getAttribute('style');
                    }
                    
                    // Make sure full text is shown
                    const headerText = header.querySelector('.header-text');
                    const headerIcon = header.querySelector('.header-icon');
                    
                    if (headerText) {
                        headerText.style.display = 'inline-block';
                    }
                    
                    if (headerIcon) {
                        headerIcon.style.display = 'none';
                    }
                });
                
                // Get the table and prepare it for full content capture
                const tableWrapper = element.querySelector('.match-history-table-wrapper');
                const table = tableWrapper ? tableWrapper.querySelector('table') : null;
                
                // Save original styles to restore later
                const originalTableStyles = {
                    table: table ? {
                        cssText: table.style.cssText,
                        maxHeight: table.style.maxHeight,
                        height: table.style.height,
                        width: table.style.width,
                        overflow: table.style.overflow
                    } : {},
                    wrapper: tableWrapper ? {
                        cssText: tableWrapper.style.cssText,
                        maxHeight: tableWrapper.style.maxHeight,
                        height: tableWrapper.style.height,
                        width: tableWrapper.style.width,
                        overflow: tableWrapper.style.overflow
                    } : {},
                    content: content ? {
                        cssText: content.style.cssText,
                        maxHeight: content.style.maxHeight,
                        height: content.style.height,
                        width: content.style.width,
                        overflow: content.style.overflow
                    } : {}
                };
                
                // Explicitly set styles to ensure full table capture
                if (tableWrapper) {
                    tableWrapper.style.maxHeight = 'none';
                    tableWrapper.style.height = 'auto';
                    tableWrapper.style.width = '100%';
                    tableWrapper.style.overflow = 'visible';
                    tableWrapper.style.maxWidth = 'none';
                }
                
                if (table) {
                    table.style.maxHeight = 'none';
                    table.style.height = 'auto';
                    table.style.width = '100%';
                    table.style.overflow = 'visible';
                    table.style.maxWidth = 'none';
                    // Ensure fixed layout to control column widths better
                    table.style.tableLayout = 'fixed';
                }
                
                if (content) {
                    content.style.maxHeight = 'none';
                    content.style.height = 'auto';
                    content.style.width = '100%';
                    content.style.overflow = 'visible';
                    content.style.maxWidth = 'none';
                }
                
                // Update html2canvas settings to ensure all content is captured
                html2canvas(element, {
                    scrollX: 0,
                    scrollY: 0,
                    scale: 2, // Higher resolution for better quality
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#FFFFFF',
                    width: 1200, // Use fixed width
                    windowWidth: 1200,
                    foreignObjectRendering: false, // Disable for better compatibility on Android
                    logging: true, // Enable logging for debugging
                    removeContainer: false, // Don't remove the container to avoid rendering issues
                    ignoreElements: (element) => {
                        // Ignore certain elements that might cause problems
                        return element.classList.contains('action-column') || 
                               element.classList.contains('action-cell');
                    },
                    onclone: function(clonedDoc) {
                        // Apply our special class to the cloned element as well
                        const clonedMatchHistory = clonedDoc.querySelector('#matchHistoryDisplay');
                        if (clonedMatchHistory) {
                            clonedMatchHistory.classList.add('match-history-capture-mode');
                            
                            // Also ensure all content is visible in the clone
                            const clonedWrapper = clonedMatchHistory.querySelector('.match-history-table-wrapper');
                            const clonedTable = clonedMatchHistory.querySelector('table');
                            const clonedContent = clonedMatchHistory.querySelector('#matchHistoryContent');
                            
                            if (clonedWrapper) {
                                clonedWrapper.style.maxHeight = 'none';
                                clonedWrapper.style.height = 'auto';
                                clonedWrapper.style.width = '100%';
                                clonedWrapper.style.overflow = 'visible';
                                clonedWrapper.style.maxWidth = 'none';
                            }
                            
                            if (clonedTable) {
                                clonedTable.style.maxHeight = 'none';
                                clonedTable.style.height = 'auto';
                                clonedTable.style.width = '100%';
                                clonedTable.style.overflow = 'visible';
                                clonedTable.style.maxWidth = 'none';
                                clonedTable.style.tableLayout = 'fixed';
                            }
                            
                            if (clonedContent) {
                                clonedContent.style.maxHeight = 'none';
                                clonedContent.style.height = 'auto';
                                clonedContent.style.width = '100%';
                                clonedContent.style.overflow = 'visible';
                                clonedContent.style.maxWidth = 'none';
                            }
                            
                            // Ensure date display is properly centered in clone
                            const clonedDateDisplay = clonedMatchHistory.querySelector('#dateDisplay');
                            if (clonedDateDisplay) {
                                clonedDateDisplay.style.textAlign = 'center';
                                clonedDateDisplay.style.margin = '15px auto 25px';
                                clonedDateDisplay.style.width = 'auto';
                            }
                        }
                    }
                }).then((canvas) => {
                    console.log('Canvas generated successfully');
                    
                    // Detect iOS/Safari
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                    
                    console.log(`Device detection in download - iOS: ${isIOS}, Safari: ${isSafari}`);
                    
                    // Create download link first - do this before any style changes
                    const link = document.createElement('a');
                    const currentDate = new Date().toISOString().slice(0, 10);
                    const downloadFilename = `${filename}-${currentDate}.png`;
                    console.log(`Creating download: ${downloadFilename}`);
                    
                    // Special handling for iOS/Safari
                    if (isIOS || isSafari) {
                        console.log('Using iOS/Safari specific download method');
                        
                        // For iOS, we need a different approach
                        // First create a blob from the canvas
                        canvas.toBlob(function(blob) {
                            // Create object URL
                            const url = URL.createObjectURL(blob);
                            
                            // For iOS Safari, we'll use a temporary link with target="_blank"
                            const tempLink = document.createElement('a');
                            tempLink.href = url;
                            tempLink.download = downloadFilename;
                            tempLink.target = "_blank"; // Open in new tab
                            tempLink.style.display = "none";
                            document.body.appendChild(tempLink);
                            
                            // Simulate click after a short delay
                            setTimeout(() => {
                                const clickEvent = new MouseEvent('click');
                                tempLink.dispatchEvent(clickEvent);
                                
                                // Clean up
                                setTimeout(() => {
                                    document.body.removeChild(tempLink);
                                    URL.revokeObjectURL(url);
                                }, 100);
                            }, 100);
                            
                            // Show special instructions for iOS
                            showToast('For iOS: Touch and hold the image, then choose "Save to Photos"', 'info', 6000);
                        }, 'image/png');
                    } else {
                        // Standard approach for other browsers
                        link.href = canvas.toDataURL('image/png');
                        link.download = downloadFilename;
                        
                        // Try-catch block to handle download errors
                        try {
                            link.click();
                            console.log('Download initiated');
                        } catch (err) {
                            console.error('Error initiating download:', err);
                            // Try alternative download method
                            try {
                                // Create a blob and use saveAs
                                canvas.toBlob(function(blob) {
                                    if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                                        // For IE
                                        window.navigator.msSaveOrOpenBlob(blob, link.download);
                                    } else {
                                        // For Android
                                        const url = URL.createObjectURL(blob);
                                        const newLink = document.createElement('a');
                                        newLink.href = url;
                                        newLink.download = link.download;
                                        document.body.appendChild(newLink);
                                        newLink.click();
                                        document.body.removeChild(newLink);
                                        URL.revokeObjectURL(url);
                                    }
                                });
                            } catch (blobErr) {
                                console.error('Error with blob download:', blobErr);
                                showToast('Download error. Please try again or check permissions.', 'error', 4000);
                            }
                        }
                    }
                    
                    // IMPORTANT: First ensure the active class is maintained
                    const wasActive = element.classList.contains('active');
                    
                    // AFTER download completes, restore original styles
                    element.style.cssText = originalStyle;
                    element.style.width = originalWidth || '';
                    element.style.height = originalHeight || '';
                    element.style.maxWidth = '';
                    element.style.minWidth = '';
                    
                    // Remove special capture class
                    element.classList.remove('match-history-capture-mode');
                    
                    // Remove the logo we added for the image (only if we added one)
                    if (logoContainer && logoContainer.parentNode) {
                        logoContainer.parentNode.removeChild(logoContainer);
                    }
                    
                    // Ensure element stays active if it was active before
                    if (wasActive) {
                        element.classList.add('active');
                        element.style.visibility = 'visible';
                        element.style.opacity = '1';
                        element.style.display = 'flex';
                    }
                                     
                    // Restore visibility of UI elements
                    if (closeBtn) closeBtn.style.display = originalBtnDisplay.closeBtn;
                    
                    // Restore content style
                    if (content) {
                        content.style.cssText = originalTableStyles.content.cssText;
                        content.style.maxHeight = originalTableStyles.content.maxHeight || '';
                        content.style.height = originalTableStyles.content.height || '';
                        content.style.width = originalTableStyles.content.width || '';
                        content.style.overflow = originalTableStyles.content.overflow || '';
                        content.style.maxWidth = '';
                    }
                    
                    // Restore table styles
                    if (table) {
                        table.style.cssText = originalTableStyles.table.cssText;
                        table.style.maxHeight = originalTableStyles.table.maxHeight || '';
                        table.style.height = originalTableStyles.table.height || '';
                        table.style.width = originalTableStyles.table.width || '';
                        table.style.overflow = originalTableStyles.table.overflow || '';
                        table.style.maxWidth = '';
                        table.style.tableLayout = '';
                        
                        // Reset all rows to their original display state
                        const allRows = table.querySelectorAll('tr');
                        allRows.forEach(row => {
                            row.style.display = '';
                            row.style.visibility = '';
                        });
                    }
                    
                    if (tableWrapper) {
                        tableWrapper.style.cssText = originalTableStyles.wrapper.cssText;
                        tableWrapper.style.maxHeight = originalTableStyles.wrapper.maxHeight || '';
                        tableWrapper.style.height = originalTableStyles.wrapper.height || '';
                        tableWrapper.style.width = originalTableStyles.wrapper.width || '';
                        tableWrapper.style.overflow = originalTableStyles.wrapper.overflow || '';
                        tableWrapper.style.maxWidth = '';
                    }
                    
                    // Restore headers
                    if (tableHeaders && tableHeaders.length > 0 && typeof originalHeaders !== 'undefined') {
                        tableHeaders.forEach((header, index) => {
                            if (originalHeaders[index]) {
                                header.innerHTML = originalHeaders[index];
                                // Reset all applied inline styles
                                header.removeAttribute('style');
                                if (originalHeaders[index + 'style']) {
                                    header.setAttribute('style', originalHeaders[index + 'style']);
                                }
                            }
                        });
                    }
                    
                    // Restore date display
                    if (dateDisplay) {
                        dateDisplay.removeAttribute('style');
                    }
                    
                    // Show success message directly here
                    console.log('Match History panel restored after image capture');
                    console.log(`Final Match History state: active=${element.classList.contains('active')}, visibility=${element.style.visibility}, display=${element.style.display}`);
                    
                    // Dispatch event to signal match history capture is complete
                    document.dispatchEvent(new CustomEvent('matchHistoryCaptureComplete'));
                    
                    showToast('Match History saved as image.', 'success', 4000);
                });
                
                // Return early since we've handled this case specifically
                return;
            }
            
            // Special handling for podium display (leaderboard)
            if (element.id === 'podiumDisplay') {
                console.log('Capturing podium display as image');
                
                // Save original width/size values to restore later
                const originalWidth = element.style.width;
                const originalHeight = element.style.height;
                
                // Set fixed width for capture that's independent of screen size
                element.style.width = '1200px';  // Set a fixed width large enough for all content
                element.style.height = 'auto';
                element.style.maxWidth = 'none';
                element.style.minWidth = '1200px';
                
                // Add logo to the top for the capture if not already present
                let logoContainer = element.querySelector('img[alt="Pickle Pairs Logo"]');
                let addedLogoContainer = false;
                
                if (!logoContainer) {
                    logoContainer = document.createElement('div');
                    logoContainer.style.textAlign = 'center';
                    logoContainer.style.marginBottom = '15px';
                    logoContainer.innerHTML = '<img src="simplelogotbase64renamed.png" alt="Pickle Pairs Logo" style="max-width: 150px; margin: 0 auto;" crossorigin="anonymous">';
                    element.insertBefore(logoContainer, element.firstChild);
                    addedLogoContainer = true;
                }
                
                // Save the original style classes and states
                const wasActive = element.classList.contains('active');
                const originalStyle = element.style.cssText;
                
                // Save original states of controls to restore later
                const closeBtn = element.querySelector('#closePodiumBtn');
                const sortingButtons = element.querySelector('.sorting-buttons');
                const saveBtn = document.getElementById('saveAsPictureBtn');
                const toggleMuteBtn = document.getElementById('toggleLeaderboardMute');
                
                const originalDisplayState = {
                    closeBtn: closeBtn ? closeBtn.style.display : '',
                    sortingButtons: sortingButtons ? sortingButtons.style.display : '',
                    saveBtn: saveBtn ? saveBtn.style.display : '',
                    toggleMuteBtn: toggleMuteBtn ? toggleMuteBtn.style.display : ''
                };
                
                // Hide UI controls only for the snapshot
                if (closeBtn) closeBtn.style.display = 'none';
                if (sortingButtons) sortingButtons.style.display = 'none';
                if (saveBtn) saveBtn.style.display = 'none';
                if (toggleMuteBtn) toggleMuteBtn.style.display = 'none';
                
                // Get the table and prepare it for full content capture
                const tableWrapper = element.querySelector('.table-wrapper');
                const table = element.querySelector('#playerStatsTable');
                
                // Find and remove drop shadows from sticky columns
                const stickyColumns = table ? table.querySelectorAll('th:nth-child(1), th:nth-child(2), td:nth-child(1), td:nth-child(2)') : [];
                const originalColumnStyles = [];
                
                // Save original styles
                stickyColumns.forEach((col, index) => {
                    originalColumnStyles[index] = {
                        element: col,
                        boxShadow: col.style.boxShadow,
                        background: col.style.background,
                        backgroundColor: col.style.backgroundColor,
                        border: col.style.border,
                        borderRight: col.style.borderRight
                    };
                    
                    // Remove shadows and borders for capture
                    col.style.boxShadow = 'none';
                    col.style.border = '1px solid #ddd';
                    col.style.borderRight = '1px solid #ddd';
                });
                
                // Save original styles to restore later
                const originalTableStyles = {
                    table: table ? {
                        cssText: table.style.cssText,
                        maxHeight: table.style.maxHeight,
                        height: table.style.height,
                        width: table.style.width,
                        overflow: table.style.overflow
                    } : {},
                    wrapper: tableWrapper ? {
                        cssText: tableWrapper.style.cssText,
                        maxHeight: tableWrapper.style.maxHeight,
                        height: tableWrapper.style.height,
                        width: tableWrapper.style.width,
                        overflow: tableWrapper.style.overflow
                    } : {}
                };
                
                // Explicitly set styles to ensure full table capture
                if (tableWrapper) {
                    tableWrapper.style.maxHeight = 'none';
                    tableWrapper.style.height = 'auto';
                    tableWrapper.style.width = '100%';
                    tableWrapper.style.overflow = 'visible';
                    tableWrapper.style.maxWidth = 'none';
                }
                
                if (table) {
                    table.style.maxHeight = 'none';
                    table.style.height = 'auto';
                    table.style.width = '100%';
                    table.style.overflow = 'visible';
                    table.style.maxWidth = 'none';
                    // Ensure fixed layout to control column widths better
                    table.style.tableLayout = 'fixed';
                    
                    // Ensure all rows are visible
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        row.style.display = 'table-row';
                        row.style.visibility = 'visible';
                    });
                }
                
                // Add the podium-capture-mode class that contains our essential styles
                element.classList.add('podium-capture-mode');
                
                console.log('Creating image of podium display with html2canvas');
                
                // Use html2canvas with improved settings
                html2canvas(element, {
                    scrollX: 0,
                    scrollY: 0,
                    scale: 2, // Higher resolution for better quality
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#FFFFFF',
                    width: 1200, // Use fixed width
                    windowWidth: 1200,
                    onclone: function(clonedDoc) {
                        // Apply our special class to the cloned element as well
                        const clonedPodium = clonedDoc.querySelector('#podiumDisplay');
                        if (clonedPodium) {
                            clonedPodium.classList.add('podium-capture-mode');
                            
                            // Also ensure all content is visible in the clone
                            const clonedWrapper = clonedPodium.querySelector('.table-wrapper');
                            const clonedTable = clonedPodium.querySelector('#playerStatsTable');
                            
                            if (clonedWrapper) {
                                clonedWrapper.style.maxHeight = 'none';
                                clonedWrapper.style.height = 'auto';
                                clonedWrapper.style.width = '100%';
                                clonedWrapper.style.overflow = 'visible';
                                clonedWrapper.style.maxWidth = 'none';
                            }
                            
                            if (clonedTable) {
                                clonedTable.style.maxHeight = 'none';
                                clonedTable.style.height = 'auto';
                                clonedTable.style.width = '100%';
                                clonedTable.style.overflow = 'visible';
                                clonedTable.style.maxWidth = 'none';
                                clonedTable.style.tableLayout = 'fixed';
                                
                                // Ensure all rows are visible in the clone
                                const clonedRows = clonedTable.querySelectorAll('tr');
                                clonedRows.forEach(row => {
                                    row.style.display = 'table-row';
                                    row.style.visibility = 'visible';
                                });
                                
                                // Remove shadows from cloned sticky columns
                                const clonedStickyColumns = clonedTable.querySelectorAll('th:nth-child(1), th:nth-child(2), td:nth-child(1), td:nth-child(2)');
                                clonedStickyColumns.forEach(col => {
                                    col.style.boxShadow = 'none';
                                    col.style.background = col.tagName === 'TH' ? 'var(--primary)' : 'white';
                                    col.style.border = '1px solid #ddd';
                                    col.style.borderRight = '1px solid #ddd';
                                    col.style.position = 'static'; // Remove sticky positioning
                                });
                                
                                // Make backgrounds consistent
                                const allCells = clonedTable.querySelectorAll('td, th');
                                allCells.forEach(cell => {
                                    if (cell.tagName === 'TH') {
                                        cell.style.backgroundColor = 'var(--primary)';
                                        cell.style.color = 'white';
                                    } else {
                                        const row = cell.closest('tr');
                                        const isEven = Array.from(row.parentNode.children).indexOf(row) % 2 === 1;
                                        cell.style.backgroundColor = isEven ? 'rgb(240, 245, 255)' : 'white';
                                    }
                                });
                            }
                            
                            // Hide UI controls in the clone
                            const clonedCloseBtn = clonedPodium.querySelector('#closePodiumBtn');
                            const clonedSortingButtons = clonedPodium.querySelector('.sorting-buttons');
                            if (clonedCloseBtn) clonedCloseBtn.style.display = 'none';
                            if (clonedSortingButtons) clonedSortingButtons.style.display = 'none';
                        }
                    }
                }).then(canvas => {
                    console.log('Canvas successfully generated for podium');
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    const currentDate = new Date().toISOString().slice(0, 10);
                    link.download = `${filename}-${currentDate}.png`;
                    link.click();
                    
                    console.log('Podium image download initiated');
                    
                    // Restore original styles AFTER the download completes
                    element.style.cssText = originalStyle;
                    element.style.width = originalWidth || '';
                    element.style.height = originalHeight || '';
                    element.style.maxWidth = '';
                    element.style.minWidth = '';
                    
                    // Remove capture mode classes
                    element.classList.remove('podium-capture-mode');
                    
                    // If we added a logo container, remove it
                    if (addedLogoContainer && logoContainer && logoContainer.parentNode) {
                        logoContainer.parentNode.removeChild(logoContainer);
                    }
                    
                    // Restore element active state
                    if (wasActive && !element.classList.contains('active')) {
                        element.classList.add('active');
                    }
                    
                    // Restore visibility of UI controls
                    if (closeBtn) closeBtn.style.display = originalDisplayState.closeBtn;
                    if (sortingButtons) sortingButtons.style.display = originalDisplayState.sortingButtons;
                    if (saveBtn) saveBtn.style.display = originalDisplayState.saveBtn;
                    if (toggleMuteBtn) toggleMuteBtn.style.display = originalDisplayState.toggleMuteBtn;
                    
                    // Restore table styles
                    if (table) {
                        table.style.cssText = originalTableStyles.table.cssText;
                        // Also restore individual properties to ensure they get reset properly
                        table.style.maxHeight = originalTableStyles.table.maxHeight || '';
                        table.style.height = originalTableStyles.table.height || '';
                        table.style.width = originalTableStyles.table.width || '';
                        table.style.overflow = originalTableStyles.table.overflow || '';
                        table.style.maxWidth = '';
                        table.style.tableLayout = '';
                    }
                    
                    if (tableWrapper) {
                        tableWrapper.style.cssText = originalTableStyles.wrapper.cssText;
                        // Also restore individual properties
                        tableWrapper.style.maxHeight = originalTableStyles.wrapper.maxHeight || '';
                        tableWrapper.style.height = originalTableStyles.wrapper.height || '';
                        tableWrapper.style.width = originalTableStyles.wrapper.width || '';
                        tableWrapper.style.overflow = originalTableStyles.wrapper.overflow || '';
                        tableWrapper.style.maxWidth = '';
                    }
                    
                    // Restore column styles
                    originalColumnStyles.forEach(col => {
                        if (col && col.element) {
                            col.element.style.boxShadow = col.boxShadow || '';
                            col.element.style.background = col.background || '';
                            col.element.style.backgroundColor = col.backgroundColor || '';
                            col.element.style.border = col.border || '';
                            col.element.style.borderRight = col.borderRight || '';
                            col.element.style.position = '';
                        }
                    });
                    
                    // Additional cleanup - restore all table rows to their original state
                    if (table) {
                        const rows = table.querySelectorAll('tr');
                        rows.forEach(row => {
                            row.style.display = '';
                            row.style.visibility = '';
                        });
                    }
                    
                    // Signal completion
                    document.dispatchEvent(new CustomEvent('podiumCaptureComplete'));
                    showToast('Leaderboard saved as image.', 'success', 4000);
                }).catch(error => {
                    console.error('Error capturing leaderboard with html2canvas:', error);
                    showToast('Error capturing leaderboard: ' + error.message, 'error', 4000);
                    
                    // Restore original styles even on error
                    element.style.cssText = originalStyle;
                    element.style.width = originalWidth || '';
                    element.style.height = originalHeight || '';
                    element.style.maxWidth = '';
                    element.style.minWidth = '';
                    
                    // Remove capture mode classes
                    element.classList.remove('podium-capture-mode');
                    
                    // Restore column styles even on error
                    originalColumnStyles.forEach(col => {
                        if (col && col.element) {
                            col.element.style.boxShadow = col.boxShadow || '';
                            col.element.style.background = col.background || '';
                            col.element.style.backgroundColor = col.backgroundColor || '';
                            col.element.style.border = col.border || '';
                            col.element.style.borderRight = col.borderRight || '';
                            col.element.style.position = '';
                        }
                    });
                    
                    // Additional cleanup
                    if (table) {
                        const rows = table.querySelectorAll('tr');
                        rows.forEach(row => {
                            row.style.display = '';
                            row.style.visibility = '';
                        });
                    }
                    
                    // Signal completion even on error
                    document.dispatchEvent(new CustomEvent('podiumCaptureComplete'));
                });
                
                return;
            }
            
            // For other elements, continue with the existing code
            const originalStyle = element.style.cssText;
            
            // Capture all content with html2canvas for other elements
            html2canvas(element, {
                scrollX: 0,
                scrollY: 0,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight,
                scale: 2, // Higher resolution
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#FFFFFF'
            }).then((canvas) => {
                // Create download link
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                const currentDate = new Date().toISOString().slice(0, 10);
                link.download = `${filename}-${currentDate}.png`;
                link.click();
            });
        }
        
    </script>
    
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        // Add a script to ensure the settings panel z-index is properly set
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded from index.html');
            
            // Add event listener for scrollToCurrentRound button
            document.getElementById('scrollToCurrentRound').addEventListener('click', function() {
                scrollToCurrentRound();
            });
            
            // Add explicit event listener for support button
            document.getElementById('supportButton').addEventListener('click', function() {
                const supportPanel = document.getElementById('support-panel');
                supportPanel.classList.toggle('open');
            });
            
            // Ensure settings panel has the correct z-index
            const debugArea = document.getElementById('debugAreaContainer');
            if (debugArea) {
                debugArea.style.zIndex = "2200";
            }
            
            // Initialize the numeric keypad
            if (typeof initNumericKeypad === 'function') {
                initNumericKeypad();
                console.log('Numeric keypad initialized');
                
                // Handle state restoration here to prevent multiple calls
                // Set a small timeout to ensure all initialization is complete
                if (!window.stateRestorationScheduled && (localStorage.getItem('pickleballCompetitionState') || 
                    localStorage.getItem('tournamentData') || localStorage.getItem('pickle-state'))) {
                    window.stateRestorationScheduled = true;
                    setTimeout(() => {
                        if (typeof restoreState === 'function') {
                            restoreState();
                        }
                    }, 100);
                }
            }
            
            // Only initialize the guide arrow once after a short delay
            // This ensures the page elements are properly loaded
            if (!window.guideArrowInitialized) {
                window.guideArrowInitialized = true;
                setTimeout(() => {
                    showGuideArrow();
                }, 700);
            }
            
            // Function to update the appearance of the floating capture button
            // REMOVED: Duplicate function definition - now defined in global scope
            
            // Set up match history button listeners for updating capture button appearance
            setupMatchHistoryListeners();
            
            // Initialize capture button appearance
            updateCaptureButtonAppearance();
        });
        
        // Function to update the appearance of the floating capture button - moved to global scope
        function updateCaptureButtonAppearance() {
            const matchHistoryDisplay = document.getElementById('matchHistoryDisplay');
            const podiumDisplay = document.getElementById('podiumDisplay');
            const saveAsPictureBtn = document.getElementById('saveAsPictureBtn');
            
            // Check if all elements exist before proceeding
            if (!matchHistoryDisplay || !podiumDisplay || !saveAsPictureBtn) {
                console.warn('One or more elements not found for updateCaptureButtonAppearance');
                return; // Exit function if any element is missing
            }
            
            if (matchHistoryDisplay.classList.contains('active') || podiumDisplay.classList.contains('active')) {
                // If match history or podium is active, show single camera icon
                saveAsPictureBtn.classList.add('toggle-capture-btn');
                saveAsPictureBtn.classList.add('single-camera-mode');
                saveAsPictureBtn.classList.remove('dual-camera-mode');
            } else {
                // Otherwise show the dual icon
                saveAsPictureBtn.classList.add('toggle-capture-btn');
                saveAsPictureBtn.classList.remove('single-camera-mode');
                saveAsPictureBtn.classList.add('dual-camera-mode');
            }
        }
        
        document.getElementById('saveAsPictureBtn').addEventListener('click', () => {
        const matchHistoryDisplay = document.getElementById('matchHistoryDisplay');
        const podiumDisplay = document.getElementById('podiumDisplay');
        
        console.log('--- SAVE AS PICTURE BUTTON CLICKED ---');
        console.log(`Match History state: active=${matchHistoryDisplay.classList.contains('active')}, visibility=${matchHistoryDisplay.style.visibility}, display=${matchHistoryDisplay.style.display}`);
        console.log(`Podium state: active=${podiumDisplay.classList.contains('active')}, visibility=${podiumDisplay.style.visibility}, display=${podiumDisplay.style.display}`);
        
        // Show a toast to indicate the process has started
        showToast('Generating images...', 'info', 2000);
        
        // Case 1: Match history is already active - capture just that
        if (matchHistoryDisplay.classList.contains('active')) {
            console.log('Match History is active - capturing only Match History');
            // Save original state so we can restore it after capture
            const originalVisibility = matchHistoryDisplay.style.visibility;
            const originalOpacity = matchHistoryDisplay.style.opacity;
            const originalDisplay = matchHistoryDisplay.style.display;
            
            console.log(`Original Match History state: visibility=${originalVisibility}, opacity=${originalOpacity}, display=${originalDisplay}`);
            
            // Capture the element - no need for setTimeout here
            captureElementAsImage(matchHistoryDisplay, 'match-history');
            
            // NOTE: We're removing this setTimeout because restoration now happens inside 
            // the html2canvas then() callback in captureElementAsImage function
            // The success toast will also be shown inside the callback after restore
        }
        // Case 2: Podium is already active - capture just that
        else if (podiumDisplay.classList.contains('active')) {
            captureElementAsImage(podiumDisplay, 'leaderboard');
        }
        // Case 3: Neither is active - capture both sequentially
        else {
            // Use the background capture method for cleaner handling
            captureElementsInBackground();
        }
        });
        
        // Add context menu for background capture
        document.getElementById('saveAsPictureBtn').addEventListener('contextmenu', (e) => {
            e.preventDefault(); // Prevent default context menu
            captureElementsInBackground();
            return false;
        });
        
        // Add tooltip to inform users about right-click option
        const saveAsPictureBtn = document.getElementById('saveAsPictureBtn');
        if (saveAsPictureBtn) {
            saveAsPictureBtn.title = "Left-click: Capture with UI panels | Right-click: Silent capture in background";
        }

        // Function to setup match history visibility change listeners
        function setupMatchHistoryListeners() {
            // Listen for match history being shown
            document.getElementById('matchesPlayed').addEventListener('click', function() {
                setTimeout(updateCaptureButtonAppearance, 100);
            });
            
            // Listen for match history being closed
            document.getElementById('closeMatchHistoryBtn').addEventListener('click', function() {
                setTimeout(updateCaptureButtonAppearance, 100);
            });
            
            // Listen for podium display being shown
            document.getElementById('showPodiumBtn').addEventListener('click', function() {
                setTimeout(updateCaptureButtonAppearance, 100);
            });
            
            // Listen for floating leaderboard button
            const floatingLeaderboardBtn = document.getElementById('floatingLeaderboardBtn');
            if (floatingLeaderboardBtn) {
                floatingLeaderboardBtn.addEventListener('click', function() {
                    setTimeout(updateCaptureButtonAppearance, 100);
                });
            }
            
            // Listen for podium display being closed
            document.getElementById('closePodiumBtn').addEventListener('click', function() {
                setTimeout(updateCaptureButtonAppearance, 100);
            });
        }

        // Function to capture both elements without showing them in the UI
        function captureElementsInBackground() {
            // Show toast to indicate process has started
            showToast('Generating images...', 'info', 2000);
            
            // Get the elements
            const matchHistoryDisplay = document.getElementById('matchHistoryDisplay');
            const podiumDisplay = document.getElementById('podiumDisplay');
            const matchHistoryContent = document.getElementById('matchHistoryContent');
            
            console.log('--- BACKGROUND CAPTURE START ---');
            
            // Save original visibility states
            const originalMatchHistoryState = {
                visibility: matchHistoryDisplay.style.visibility,
                opacity: matchHistoryDisplay.style.opacity,
                display: matchHistoryDisplay.style.display,
                active: matchHistoryDisplay.classList.contains('active'),
                position: matchHistoryDisplay.style.position,
                zIndex: matchHistoryDisplay.style.zIndex,
                width: matchHistoryDisplay.style.width,
                height: matchHistoryDisplay.style.height,
                maxWidth: matchHistoryDisplay.style.maxWidth,
                minWidth: matchHistoryDisplay.style.minWidth
            };
            
            const originalPodiumState = {
                visibility: podiumDisplay.style.visibility,
                opacity: podiumDisplay.style.opacity,
                display: podiumDisplay.style.display,
                active: podiumDisplay.classList.contains('active'),
                position: podiumDisplay.style.position,
                zIndex: podiumDisplay.style.zIndex,
                width: podiumDisplay.style.width,
                height: podiumDisplay.style.height,
                maxWidth: podiumDisplay.style.maxWidth,
                minWidth: podiumDisplay.style.minWidth
            };
            
            // Prepare match history for capture - make it positioned off-screen but fully rendered
            matchHistoryDisplay.classList.add('active'); // Need active class for structure
            matchHistoryDisplay.style.position = 'absolute';
            matchHistoryDisplay.style.left = '-9999px'; // Position off-screen instead of hiding
            matchHistoryDisplay.style.visibility = 'visible'; // Keep visible for proper rendering
            matchHistoryDisplay.style.opacity = '1'; // Keep opacity normal for rendering
            matchHistoryDisplay.style.display = 'flex';
            matchHistoryDisplay.style.zIndex = '999999'; // High z-index to ensure it's on top of any stacking context
            matchHistoryDisplay.style.pointerEvents = 'none'; // Prevent interactions
            
            // Set fixed width for capture
            matchHistoryDisplay.style.width = '1200px';
            matchHistoryDisplay.style.height = 'auto';
            matchHistoryDisplay.style.maxWidth = 'none';
            matchHistoryDisplay.style.minWidth = '1200px';
            
            // Clear current content and explicitly rebuild it
            matchHistoryContent.innerHTML = '';
            
            // Add date display
            const dateElement = document.createElement('div');
            dateElement.id = 'dateDisplay';
            matchHistoryContent.appendChild(dateElement);
            displayCurrentDate(dateElement);
            
            // Either show empty state or build the match history table
            if (matches.length === 0) {
                matchHistoryContent.innerHTML += '<div class="empty-state">No matches have been played yet.</div>';
            } else {
                // Explicitly build the table with our function
                if (typeof buildMatchHistoryTable === 'function') {
                    buildMatchHistoryTable(matchHistoryContent);
                } else {
                    // Fallback if function isn't available
                    console.log('Building match history table manually');
                    
                    // Create a scrollable wrapper for the table
                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'match-history-table-wrapper';
                    
                    // Create a table to display match history
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>
                                    <span class="header-text">Round</span>
                                    <span class="header-icon" title="Round"><span class="material-symbols-rounded">filter_1</span></span>
                                </th>
                                <th>
                                    <span class="header-text">Match</span>
                                    <span class="header-icon" title="Match"><span class="material-symbols-rounded">sports_tennis</span></span>
                                </th>
                                <th>
                                    <span class="header-text">Team 1</span>
                                    <span class="header-icon" title="Team 1"><span class="material-symbols-rounded">group</span><span class="team-number">1</span></span>
                                </th>
                                <th>
                                    <span class="header-text">Team 2</span>
                                    <span class="header-icon" title="Team 2"><span class="material-symbols-rounded">group</span><span class="team-number">2</span></span>
                                </th>
                                <th>
                                    <span class="header-text">Score</span>
                                    <span class="header-icon" title="Score"><span class="material-symbols-rounded">scoreboard</span></span>
                                </th>
                                <th class="action-column">
                                    <span class="header-text">Actions</span>
                                    <span class="header-icon" title="Actions"><span class="material-symbols-rounded">edit</span></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    const tableBody = table.querySelector('tbody');
                    
                    // Group matches by round and track match occurrences
                    const matchColors = {}; // To store a unique color for each repeated match
                    const matchKeyMap = {}; // To count occurrences of each match key
                
                    // First, sort matches by round, then by original index
                    const sortedMatches = matches.map((match, index) => ({
                        match,
                        originalIndex: index
                    })).sort((a, b) => {
                        // Sort by round first (ascending)
                        if (a.match.round !== b.match.round) {
                            return a.match.round - b.match.round;
                        }
                        // If rounds are the same, sort by original index
                        return a.originalIndex - b.originalIndex;
                    });
                
                    // Count match occurrences and prepare color mapping
                    sortedMatches.forEach(({ match }) => {
                        const matchKey = generateMatchKey(match.team1, match.team2);
                
                        // Count occurrences of each match
                        if (!matchKeyMap[matchKey]) {
                            matchKeyMap[matchKey] = { count: 0, color: null };
                        }
                        matchKeyMap[matchKey].count++;
                
                        // Assign a color if it's a repeated match
                        if (matchKeyMap[matchKey].count > 1 && !matchKeyMap[matchKey].color) {
                            matchKeyMap[matchKey].color = generateUniqueColor(Object.keys(matchColors).length);
                            matchColors[matchKey] = matchKeyMap[matchKey].color;
                        }
                    });
                
                    // Display matches in sorted order but keep original index reference for edit functionality
                    sortedMatches.forEach(({ match, originalIndex }, displayIndex) => {
                        const matchKey = generateMatchKey(match.team1, match.team2);
                        const row = document.createElement('tr');
                        row.setAttribute('data-match-index', originalIndex); // Keep original index for edit functionality
                
                        // Apply the assigned color for repeated matches
                        if (matchColors[matchKey]) {
                            row.style.backgroundColor = matchColors[matchKey];
                        }
                        
                        // Display the actual round number
                        row.innerHTML = `
                            <td>${match.round}</td>
                            <td>${displayIndex + 1}</td>
                            <td class="team-cell ${match.team1Score > match.team2Score ? 'history-winner-team' : (match.team1Score === match.team2Score && match.team1Score > 0 ? 'history-tie-team' : '')}">
                                <div class="team-players team1-players">
                                    ${match.team1.map(player => 
                                        `<span class="team1-badge">${player.name}</span>`).join('')}
                                </div>
                            </td>
                            <td class="team-cell ${match.team2Score > match.team1Score ? 'history-winner-team' : (match.team1Score === match.team2Score && match.team2Score > 0 ? 'history-tie-team' : '')}">
                                <div class="team-players team2-players">
                                    ${match.team2.map(player => 
                                        `<span class="team2-badge">${player.name}</span>`).join('')}
                                </div>
                            </td>
                            <td><strong>${match.team1Score || 0} - ${match.team2Score || 0}</strong></td>
                            <td class="action-cell"><button class="edit-match-btn" data-match-index="${originalIndex}">
                                <span class="material-symbols-rounded">edit</span>
                            </button></td>
                        `;
                        tableBody.appendChild(row);
                    });
                
                    // Add the table to the wrapper and the wrapper to the content
                    tableWrapper.appendChild(table);
                    matchHistoryContent.appendChild(tableWrapper);
                }
            }
            
            // Listen for match history capture completion
            const matchHistoryCaptureListener = function() {
                document.removeEventListener('matchHistoryCaptureComplete', matchHistoryCaptureListener);
                
                console.log('Match History capture completed, now capturing podium');
                
                // Detect iOS/Safari for increased delays
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                
                // Use much longer delay for iOS/Safari between captures
                const secondCaptureDelay = (isIOS || isSafari) ? 2500 : 500;
                console.log(`Using second capture delay of ${secondCaptureDelay}ms for iOS: ${isIOS}, Safari: ${isSafari}`);
                
                // Restore original match history state
                if (!originalMatchHistoryState.active) {
                    matchHistoryDisplay.classList.remove('active');
                }
                matchHistoryDisplay.style.position = originalMatchHistoryState.position || '';
                matchHistoryDisplay.style.left = 'auto';
                matchHistoryDisplay.style.visibility = originalMatchHistoryState.visibility || '';
                matchHistoryDisplay.style.opacity = originalMatchHistoryState.opacity || '';
                matchHistoryDisplay.style.display = originalMatchHistoryState.display || '';
                matchHistoryDisplay.style.zIndex = originalMatchHistoryState.zIndex || '';
                matchHistoryDisplay.style.pointerEvents = 'auto';
                matchHistoryDisplay.style.width = originalMatchHistoryState.width || '';
                matchHistoryDisplay.style.height = originalMatchHistoryState.height || '';
                matchHistoryDisplay.style.maxWidth = originalMatchHistoryState.maxWidth || '';
                matchHistoryDisplay.style.minWidth = originalMatchHistoryState.minWidth || '';
                
                // Also remove the capture mode class to reset all CSS styles
                matchHistoryDisplay.classList.remove('match-history-capture-mode');
                
                // Reset any table styles that might have been set
                const matchHistoryContent = matchHistoryDisplay.querySelector('#matchHistoryContent');
                if (matchHistoryContent) {
                    matchHistoryContent.style.maxHeight = '';
                    matchHistoryContent.style.height = '';
                    matchHistoryContent.style.width = '';
                    matchHistoryContent.style.overflow = '';
                    matchHistoryContent.style.maxWidth = '';
                }
                
                // Reset table wrapper and table styles
                const historyTableWrapper = matchHistoryDisplay.querySelector('.match-history-table-wrapper');
                const historyTable = historyTableWrapper ? historyTableWrapper.querySelector('table') : null;
                
                if (historyTableWrapper) {
                    historyTableWrapper.style.maxHeight = '';
                    historyTableWrapper.style.height = '';
                    historyTableWrapper.style.width = '';
                    historyTableWrapper.style.overflow = '';
                    historyTableWrapper.style.maxWidth = '';
                }
                
                if (historyTable) {
                    historyTable.style.maxHeight = '';
                    historyTable.style.height = '';
                    historyTable.style.width = '';
                    historyTable.style.overflow = '';
                    historyTable.style.maxWidth = '';
                    historyTable.style.tableLayout = '';
                    
                    // Reset all rows
                    const rows = historyTable.querySelectorAll('tr');
                    rows.forEach(row => {
                        row.style.display = '';
                        row.style.visibility = '';
                    });
                }
                
                // Now start podium capture with the same technique but with delay for iOS
                setTimeout(() => {
                    if (!podiumDisplay) {
                        console.error('Podium display element not found, cannot capture');
                        showToast('Only match history was captured.', 'info', 4000);
                        return;
                    }

                    podiumDisplay.classList.add('active');
                    podiumDisplay.style.position = 'absolute';
                    podiumDisplay.style.left = '-9999px'; // Position off-screen
                    podiumDisplay.style.visibility = 'visible';
                    podiumDisplay.style.opacity = '1';
                    podiumDisplay.style.display = 'flex';
                    podiumDisplay.style.zIndex = '999999';
                    podiumDisplay.style.pointerEvents = 'none';
                    
                    // Set fixed width for podium capture
                    podiumDisplay.style.width = '1200px';
                    podiumDisplay.style.height = 'auto';
                    podiumDisplay.style.maxWidth = 'none';
                    podiumDisplay.style.minWidth = '1200px';
                    
                    // Add our new class for podium capture
                    podiumDisplay.classList.add('podium-capture-mode');
                    
                    // Get the table and prepare it for full capture
                    const podiumTableWrapper = podiumDisplay.querySelector('.table-wrapper');
                    const podiumTable = podiumDisplay.querySelector('#playerStatsTable');
                    
                    if (podiumTableWrapper) {
                        podiumTableWrapper.style.maxHeight = 'none';
                        podiumTableWrapper.style.height = 'auto';
                        podiumTableWrapper.style.width = '100%';
                        podiumTableWrapper.style.overflow = 'visible';
                        podiumTableWrapper.style.maxWidth = '1160px';
                    }
                    
                    if (podiumTable) {
                        podiumTable.style.maxHeight = 'none';
                        podiumTable.style.height = 'auto';
                        podiumTable.style.width = '100%';
                        podiumTable.style.overflow = 'visible';
                        podiumTable.style.maxWidth = '1160px';
                        podiumTable.style.tableLayout = 'fixed';
                        
                        // Ensure all rows are visible
                        const podiumRows = podiumTable.querySelectorAll('tr');
                        podiumRows.forEach(row => {
                            row.style.display = 'table-row';
                            row.style.visibility = 'visible';
                        });
                    }
                    
                    // Add additional delay for iOS/Safari to ensure downloads complete properly
                    setTimeout(() => {
                        // Listen for podium capture completion
                        const podiumCaptureListener = function() {
                            document.removeEventListener('podiumCaptureComplete', podiumCaptureListener);
                            
                            console.log('Podium capture completed, restoring original state');
                            
                            // Restore original podium state
                            if (!originalPodiumState.active) {
                                podiumDisplay.classList.remove('active');
                            }
                            podiumDisplay.style.position = originalPodiumState.position || '';
                            podiumDisplay.style.left = 'auto';
                            podiumDisplay.style.visibility = originalPodiumState.visibility || '';
                            podiumDisplay.style.opacity = originalPodiumState.opacity || '';
                            podiumDisplay.style.display = originalPodiumState.display || '';
                            podiumDisplay.style.zIndex = originalPodiumState.zIndex || '';
                            podiumDisplay.style.pointerEvents = 'auto';
                            podiumDisplay.style.width = originalPodiumState.width || '';
                            podiumDisplay.style.height = originalPodiumState.height || '';
                            podiumDisplay.style.maxWidth = originalPodiumState.maxWidth || '';
                            podiumDisplay.style.minWidth = originalPodiumState.minWidth || '';
                            
                            // Remove the capture mode class
                            podiumDisplay.classList.remove('podium-capture-mode');
                            
                            // Reset table wrapper and table styles
                            const podiumTableWrapper = podiumDisplay.querySelector('.table-wrapper');
                            const podiumTable = podiumDisplay.querySelector('#playerStatsTable');
                            
                            if (podiumTableWrapper) {
                                podiumTableWrapper.style.maxHeight = '';
                                podiumTableWrapper.style.height = '';
                                podiumTableWrapper.style.width = '';
                                podiumTableWrapper.style.overflow = '';
                                podiumTableWrapper.style.maxWidth = '';
                            }
                            
                            if (podiumTable) {
                                podiumTable.style.maxHeight = '';
                                podiumTable.style.height = '';
                                podiumTable.style.width = '';
                                podiumTable.style.overflow = '';
                                podiumTable.style.maxWidth = '';
                                podiumTable.style.tableLayout = '';
                                
                                // Reset all rows
                                const podiumRows = podiumTable.querySelectorAll('tr');
                                podiumRows.forEach(row => {
                                    row.style.display = '';
                                    row.style.visibility = '';
                                });
                                
                                // Reset sticky columns
                                const stickyColumns = podiumTable.querySelectorAll('th:nth-child(1), th:nth-child(2), td:nth-child(1), td:nth-child(2)');
                                stickyColumns.forEach(col => {
                                    col.style.boxShadow = '';
                                    col.style.background = '';
                                    col.style.backgroundColor = '';
                                    col.style.border = '';
                                    col.style.borderRight = '';
                                    col.style.position = '';
                                });
                            }
                            
                            // For iOS/Safari, show a completion message with instructions
                            if (isIOS || isSafari) {
                                showToast('Both images generated. For iOS: Check your browser downloads or save from the opened images.', 'success', 6000);
                            } else {
                                showToast('Both images saved.', 'success', 4000);
                            }
                        };
                        
                        document.addEventListener('podiumCaptureComplete', podiumCaptureListener);
                        
                        // Capture the podium
                        captureElementAsImage(podiumDisplay, 'leaderboard');
                    }, isIOS || isSafari ? 1000 : 0);
                }, secondCaptureDelay);
            };
            
            document.addEventListener('matchHistoryCaptureComplete', matchHistoryCaptureListener);
            
            // Detect iOS/Safari
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            
            // Use longer delays and different approach for iOS/Safari
            const delayTime = (isIOS || isSafari) ? 1000 : 500;
            console.log(`Device detection - iOS: ${isIOS}, Safari: ${isSafari}, using delay: ${delayTime}ms`);
            
            setTimeout(() => {
                // Add our new class for match history capture
                matchHistoryDisplay.classList.add('match-history-capture-mode');
                
                // Ensure all content is fully visible
                const matchHistoryContent = matchHistoryDisplay.querySelector('#matchHistoryContent');
                if (matchHistoryContent) {
                    matchHistoryContent.style.maxHeight = 'none';
                    matchHistoryContent.style.height = 'auto';
                    matchHistoryContent.style.width = '100%';
                    matchHistoryContent.style.overflow = 'visible';
                    matchHistoryContent.style.maxWidth = '1160px';
                }
                
                // Get the table and prepare it for full capture
                const historyTableWrapper = matchHistoryDisplay.querySelector('.match-history-table-wrapper');
                const historyTable = historyTableWrapper ? historyTableWrapper.querySelector('table') : null;
                
                if (historyTableWrapper) {
                    historyTableWrapper.style.maxHeight = 'none';
                    historyTableWrapper.style.height = 'auto';
                    historyTableWrapper.style.width = '100%';
                    historyTableWrapper.style.overflow = 'visible';
                    historyTableWrapper.style.maxWidth = '1160px';
                }
                
                if (historyTable) {
                    historyTable.style.maxHeight = 'none';
                    historyTable.style.height = 'auto';
                    historyTable.style.width = '100%';
                    historyTable.style.overflow = 'visible';
                    historyTable.style.maxWidth = '1160px';
                    historyTable.style.tableLayout = 'fixed';
                    
                    // Ensure all rows are visible
                    const rows = historyTable.querySelectorAll('tr');
                    rows.forEach(row => {
                        row.style.display = 'table-row';
                        row.style.visibility = 'visible';
                    });
                }
                
                // Add extra delay for Android rendering
                setTimeout(() => {
                    console.log('Initiating match history capture after delay');
                    captureElementAsImage(matchHistoryDisplay, 'match-history');
                }, delayTime); // Use adaptive delay time
            }, delayTime); // Use adaptive delay time
        }
        
        // Listen for podium display being closed
            document.getElementById('closePodiumBtn').addEventListener('click', function() {
                setTimeout(updateCaptureButtonAppearance, 100);
            });
        
        // Add keyboard shortcut for background capture (Ctrl+Shift+S)
        document.addEventListener('keydown', function(e) {
            // Check if Ctrl+Shift+S was pressed
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault(); // Prevent default browser save action
                captureElementsInBackground();
            }
        });
        
        // Support panel toggle function
        function toggleSupportPanel() {
            console.log('toggleSupportPanel called');
            const supportPanel = document.getElementById('support-panel');
            if (supportPanel) {
                supportPanel.classList.toggle('open');
            } else {
                console.error('Support panel element not found');
            }
        }
    
        // Add click event listener for floating match history button
        document.getElementById('floatingMatchHistoryBtn').addEventListener('click', function() {
            console.log("Floating Match History button clicked");
            showMatchHistory();
        });
    </script>

    <!-- Add app.js for floating button container functionality -->
    <script src="app.js"></script>

    <!-- Main Script -->
    <script src="script.js"></script>
    
    <!-- Orientation change handling script -->
    <script>
        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            // Prevent zooming issues by forcing viewport refresh
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta) {
                viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                setTimeout(function() {
                    viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no';
                }, 300);
            }
            
            // Force layout recalculation
            document.body.style.display = 'none';
            setTimeout(function() {
                document.body.style.display = '';
                window.scrollTo(0, 0);
            }, 50);
        });
        
        // Handle ad layout issues
        function fixAdLayouts() {
            const ads = document.querySelectorAll('ins.adsbygoogle');
            if (ads) {
                ads.forEach(ad => {
                    ad.style.maxWidth = '100%';
                    ad.style.overflow = 'hidden';
                });
            }
        }
        
        // Run on load and resize
        window.addEventListener('load', fixAdLayouts);
        window.addEventListener('resize', fixAdLayouts);
    </script>
</body>
</html>
